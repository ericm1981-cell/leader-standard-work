<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="theme-color" content="#060b12"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Leader Standard Work</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{background:#060b12;min-height:100vh}
input:focus,select:focus,textarea:focus{outline:none;border-color:#3b82f6!important}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:#1f2937}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.fade{animation:fadeUp 0.25s ease}
@keyframes sIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
.notif{animation:sIn 0.3s ease}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

// ‚îÄ‚îÄ‚îÄ TRANSLATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const T = {
  en: {
    appTitle: "LEADER STANDARD WORK", appSub: "TIME DIAGNOSTIC ¬∑ WORK LEVEL ANALYSIS",
    loggingFor: "LOGGING FOR:",
    tabs: { log:"LOG TASKS", lsw:"MY LSW", required:"REQUIRED", watch:"CRITICAL WATCH", guide:"GUIDE", analyze:"ANALYZE", action:"ACTION PLAN" },
    addTask:"Log a task as", addTaskHint:"Press Enter ‚Äî opens immediately for details",
    logInstructions: "WHAT TO LOG",
    logHints: {
      "Team Member": ["Tasks your TL asked you to do outside your normal job","Times you had to wait ‚Äî for parts, equipment, instructions","Quality issues you found or were asked to fix","Anything that slowed your work down"],
      "Team Leader": ["Every time you stepped in to fix something instead of coaching","Meetings, reports, or data you pulled yourself","Any time you covered a team member's role","Firefighting ‚Äî what broke, what you did, how long it took","Coaching interactions ‚Äî structured or reactive"],
      "Supervisor": ["Every gemba walk ‚Äî how long, what you observed","Meetings you attended ‚Äî were you the right person there?","Problems TLs brought you ‚Äî did you solve them or coach?","Reports or data you built or pulled yourself","Firefighting you got pulled into","Time spent on admin vs. floor vs. developing people"],
      "Manager": ["Meetings ‚Äî should a supervisor own these?","Problems you solved that supervisors should own","Time verifying results vs. verifying standard work execution","Coaching supervisors vs. doing their work","Strategic work vs. operational firefighting"]
    },
    noTasks:"START LOGGING YOUR DAY", noTasksSub:"Every task ‚Äî planned or reactive. Be specific and honest.",
    taskCount:"TASKS LOGGED", logged:"LOGGED", firefighting:"FIREFIGHTING", wrongLevel:"WRONG LEVEL",
    description:"Task Description", category:"Category", timeSpent:"Time (min)", timeBin:"When in shift?",
    whoInvolved:"Who was involved?", isFF:"Is this firefighting?",
    ffCause:"Root Cause", ffNote:"What happened + countermeasure idea...",
    disposition:"Disposition", pushTo:"Push to which level?",
    pushNote:"What must happen for them to own it?", eliminateNote:"Why does it exist? Who stops it?",
    notes:"Notes / Concerns", remove:"Remove", yes:"Yes", no:"No", selectCat:"Select...", selectLevel:"Select level...",
    consultantPrompts:"LEAN CONSULTANT PROMPTS", wrongWork:"DOESN'T BELONG HERE",
    reflectionLabel:"Your reflection:", reflectionPH:"Honest answer ‚Äî not the job description, but how you actually spent your last 5 days...",
    actionPlan:"ACTION PLAN", pushDown:"PUSH DOWN", eliminate:"ELIMINATE",
    ffAnalysis:"FIREFIGHTING ANALYSIS", maintain:"MAINTAIN ‚Äî YOUR REAL JOB",
    maintainSub:"Right-level work. Build these into your standard work.",
    keyQuestion:"KEY QUESTION:", keyQuestionText:"Same fires keep happening? The system is broken ‚Äî not the people. What standard or process must change?",
    exportLSW:"Export LSW", exportPDF:"‚Üì PDF Trifold", exportXL:"‚Üì Excel Trifold", exportPickTitle:"Export Format", exportPickSub:"Choose export format for", noActionYet:"Log tasks and assign dispositions to see your action plan.",
    delegateTo:"‚Üí Delegate to:", timeCat:"TIME BY CATEGORY", crossLevel:"ALL LEVELS",
    tasks:"tasks", noTasksLogged:"No tasks ‚Äî tap to add", toPushDown:"to push down",
    requiredTitle:"REQUIRED ACTIVITIES", requiredSub:"Non-negotiables. These build your standard work schedule and layered audit.",
    addRequired:"Add required activity...",
    freqOpts:["Each Shift","Daily","2x Daily","3x Daily","Weekly","Monthly","As Needed"],
    weekdays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],
    timeOfDay:"Time of Day", duration:"Duration (min)", standard:"Standard / What good looks like",
    dayOfWeek:"Day of Week", dayOfMonth:"Day of Month",
    auditTier:"Verification ‚Äî who confirms this was done?",
    auditTierHint:"This becomes your layered audit. Who checks one level up?",
    owner:"Owner", addActivity:"Add", editActivity:"Edit", saveActivity:"Save",
    loadTemplate:"Load Supervisor Template", templateLoaded:"Template loaded",
    watchTitle:"CRITICAL WATCH", watchSub:"What you monitor for Safety, Quality, Delivery, Cost. Drives your layered audit.",
    addWatch:"Add watch item...", watchCat:"Category",
    watchCats:["Safety","Quality","Delivery","Cost"],
    timesPerDay:"Times per day", checkBy:"Checked by (select all levels)",
    threshold:"Alert threshold / condition", thresholdPH:"e.g. Scrap > 2%, Near miss logged, OTD < 95%",
    auditNote:"Action if threshold breached", auditNotePH:"e.g. Stop line, call quality, escalate...",
    layeredAuditSeed:"LAYERED AUDIT STRUCTURE", layeredAuditDesc:"Who checks what, and when ‚Äî built from your required activities and watch items:",
    addWatchItem:"Add Watch Item", saving:"Saved", noWatchYet:"No watch items. Add above to build your layered audit.",
    lswTitle:"MY LEADER STANDARD WORK", lswSub:"Required activities + Maintain tasks assembled by shift position. Layered audit verification shown.",
    noLSW:"Add Required Activities and classify tasks as Maintain to build your LSW schedule.",
    lswLayeredAudit:"LAYERED AUDIT CHECKS",
    aiCoach:"AI COACH", aiCoachBtn:"Analyze with Lean Coach", aiThinking:"Analyzing...", aiError:"Unable to connect.",
    timeBins:["Start of Shift","Morning","Mid-Shift","End of Shift","Weekly","Monthly"],
    freq:"Frequency",
  },
  es: {
    appTitle:"TRABAJO EST√ÅNDAR DEL L√çDER", appSub:"DIAGN√ìSTICO DE TIEMPO ¬∑ AN√ÅLISIS DE NIVEL",
    loggingFor:"REGISTRANDO PARA:",
    tabs:{ log:"TAREAS", lsw:"MI TSL", required:"REQUERIDAS", watch:"VIGILANCIA", guide:"GU√çA", analyze:"ANALIZAR", action:"PLAN ACCI√ìN" },
    addTask:"Registra una tarea como", addTaskHint:"Presiona Enter ‚Äî abre inmediatamente",
    logInstructions:"QU√â REGISTRAR",
    logHints:{
      "Team Member":["Tareas que tu TL te pidi√≥ fuera de tu trabajo normal","Veces que tuviste que esperar ‚Äî partes, equipo, instrucciones","Problemas de calidad que encontraste o te pidieron resolver","Cualquier cosa que fren√≥ tu trabajo"],
      "Team Leader":["Cada vez que interviniste para arreglar algo en lugar de entrenar","Reuniones, reportes o datos que t√∫ mismo extrajiste","Cuando cubriste el rol de un miembro del equipo","Apagando fuegos ‚Äî qu√© se rompi√≥, qu√© hiciste, cu√°nto tard√≥","Interacciones de coaching ‚Äî estructuradas o reactivas"],
      "Supervisor":["Cada gemba walk ‚Äî duraci√≥n, qu√© observaste","Reuniones a las que asististe ‚Äî ¬øeras la persona correcta?","Problemas que los TLs te trajeron ‚Äî ¬ølos resolviste o entrenaste?","Reportes o datos que t√∫ construiste o extrajiste","Apagado de fuegos en que te involucraste","Tiempo en admin vs. piso vs. desarrollar personas"],
      "Manager":["Reuniones ‚Äî ¬ødeber√≠a un supervisor dirigirlas?","Problemas que resolviste que supervisores deber√≠an resolver","Tiempo verificando resultados vs. ejecuci√≥n de trabajo est√°ndar","Entrenar supervisores vs. hacer su trabajo","Trabajo estrat√©gico vs. apagando fuegos operativos"]
    },
    noTasks:"COMIENZA A REGISTRAR", noTasksSub:"Cada tarea ‚Äî planificada o reactiva. S√© espec√≠fico.",
    taskCount:"TAREAS REGISTRADAS", logged:"REGISTRADO", firefighting:"APAGANDO FUEGOS", wrongLevel:"NIVEL INCORRECTO",
    description:"Descripci√≥n", category:"Categor√≠a", timeSpent:"Tiempo (min)", timeBin:"¬øCu√°ndo en el turno?",
    whoInvolved:"¬øQui√©n estuvo involucrado?", isFF:"¬øEs apagando fuegos?",
    ffCause:"Causa Ra√≠z", ffNote:"¬øQu√© pas√≥ + idea de contramedida?",
    disposition:"Disposici√≥n", pushTo:"¬øDelegar a qu√© nivel?",
    pushNote:"¬øQu√© debe pasar para que lo asuman?", eliminateNote:"¬øPor qu√© existe? ¬øQui√©n lo detiene?",
    notes:"Notas / Preocupaciones", remove:"Eliminar", yes:"S√≠", no:"No", selectCat:"Seleccionar...", selectLevel:"Seleccionar nivel...",
    consultantPrompts:"PREGUNTAS DEL CONSULTOR LEAN", wrongWork:"NO PERTENECE AQU√ç",
    reflectionLabel:"Tu reflexi√≥n:", reflectionPH:"Respuesta honesta ‚Äî no la descripci√≥n del puesto, sino c√≥mo realmente pasaste los √∫ltimos 5 d√≠as...",
    actionPlan:"PLAN DE ACCI√ìN", pushDown:"DELEGAR ABAJO", eliminate:"ELIMINAR",
    ffAnalysis:"AN√ÅLISIS APAGADO FUEGOS", maintain:"MANTENER ‚Äî TU TRABAJO REAL",
    maintainSub:"Trabajo del nivel correcto. Incl√∫yelo en tu trabajo est√°ndar.",
    keyQuestion:"PREGUNTA CLAVE:", keyQuestionText:"¬øLos mismos problemas siguen? El sistema est√° roto ‚Äî no las personas. ¬øQu√© est√°ndar debe cambiar?",
    exportLSW:"Exportar TSL", exportPDF:"‚Üì PDF Tr√≠ptico", exportXL:"‚Üì Excel Tr√≠ptico", exportPickTitle:"Formato de Exportaci√≥n", exportPickSub:"Elige formato para", noActionYet:"Registra tareas y asigna disposiciones para ver tu plan.",
    delegateTo:"‚Üí Delegar a:", timeCat:"TIEMPO POR CATEGOR√çA", crossLevel:"TODOS LOS NIVELES",
    tasks:"tareas", noTasksLogged:"Sin tareas ‚Äî toca para agregar", toPushDown:"para delegar",
    requiredTitle:"ACTIVIDADES REQUERIDAS", requiredSub:"No negociables. Construyen tu horario est√°ndar y auditor√≠a por capas.",
    addRequired:"Agregar actividad requerida...",
    freqOpts:["Cada Turno","Diario","2x al D√≠a","3x al D√≠a","Semanal","Mensual","Seg√∫n sea necesario"],
    weekdays:["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"],
    timeOfDay:"Hora del d√≠a", duration:"Duraci√≥n (min)", standard:"Est√°ndar / C√≥mo se ve bien",
    dayOfWeek:"D√≠a de la semana", dayOfMonth:"D√≠a del mes",
    auditTier:"Verificaci√≥n ‚Äî ¬øqui√©n confirma que se hizo?",
    auditTierHint:"Esto se convierte en tu auditor√≠a por capas. ¬øQui√©n revisa un nivel arriba?",
    owner:"Responsable", addActivity:"Agregar", editActivity:"Editar", saveActivity:"Guardar",
    loadTemplate:"Cargar Plantilla de Supervisor", templateLoaded:"Plantilla cargada",
    watchTitle:"VIGILANCIA CR√çTICA", watchSub:"Qu√© monitoreas para Seguridad, Calidad, Entrega, Costo.",
    addWatch:"Agregar elemento...", watchCat:"Categor√≠a",
    watchCats:["Seguridad","Calidad","Entrega","Costo"],
    timesPerDay:"Veces por d√≠a", checkBy:"Verificado por",
    threshold:"Umbral / condici√≥n de alerta", thresholdPH:"ej. Desperdicio > 2%, OTD < 95%",
    auditNote:"Acci√≥n si se supera umbral", auditNotePH:"ej. Detener l√≠nea, llamar a calidad...",
    layeredAuditSeed:"ESTRUCTURA DE AUDITOR√çA POR CAPAS", layeredAuditDesc:"Qui√©n verifica qu√© y cu√°ndo:",
    addWatchItem:"Agregar Elemento", saving:"Guardado", noWatchYet:"Sin elementos. Agrega arriba.",
    lswTitle:"MI TRABAJO EST√ÅNDAR DE L√çDER", lswSub:"Actividades requeridas + tareas a Mantener por posici√≥n en turno.",
    noLSW:"Completa Actividades Requeridas y clasifica tareas como Mantener para construir tu TSL.",
    lswLayeredAudit:"VERIFICACI√ìN DE AUDITOR√çA POR CAPAS",
    aiCoach:"COACH IA", aiCoachBtn:"Analizar con Coach Lean", aiThinking:"Analizando...", aiError:"No se pudo conectar.",
    timeBins:["Inicio de Turno","Ma√±ana","Medio Turno","Fin de Turno","Semanal","Mensual"],
    freq:"Frecuencia",
  }
};

const LEVELS = ["Team Member","Team Leader","Supervisor","Manager"];
const LL = { "Team Member":{en:"Team Member",es:"Miembro"}, "Team Leader":{en:"Team Leader",es:"L√≠der Equipo"}, "Supervisor":{en:"Supervisor",es:"Supervisor"}, "Manager":{en:"Manager",es:"Gerente"} };
const LC = { "Team Member":"#22c55e", "Team Leader":"#3b82f6", "Supervisor":"#a855f7", "Manager":"#f97316" };

const DISPOSITIONS = {
  MAINTAIN:     {en:"Maintain",    es:"Mantener",      color:"#16a34a",bg:"#052e16",icon:"‚úì"},
  PUSH_DOWN:    {en:"Push Down",   es:"Delegar Abajo", color:"#d97706",bg:"#1c1003",icon:"‚Üì"},
  ELIMINATE:    {en:"Eliminate",   es:"Eliminar",      color:"#dc2626",bg:"#1c0202",icon:"‚úï"},
  FIREFIGHTING: {en:"Firefighting",es:"Apagar Fuegos", color:"#ea580c",bg:"#1c0a02",icon:"üî•"},
  ESCALATE:     {en:"Escalate",    es:"Escalar",       color:"#7c3aed",bg:"#120a1c",icon:"‚Üë"},
};

const CATS = {
  en:["Quality Response","Production / Output","People / Coaching","Meetings","Data / Reporting","Equipment / Maintenance","Scheduling","Communication","Safety","Continuous Improvement","Administrative","Other"],
  es:["Respuesta Calidad","Producci√≥n","Personas / Coaching","Reuniones","Datos / Reportes","Equipo / Mantenimiento","Programaci√≥n","Comunicaci√≥n","Seguridad","Mejora Continua","Administrativo","Otro"]
};
const FF_CAUSES = {
  en:["No standard exists","Standard not followed","Training gap","Equipment failure","Material shortage","Planning/scheduling failure","Communication breakdown","Recurring ‚Äî systemic","One-time anomaly"],
  es:["No existe est√°ndar","Est√°ndar no seguido","Brecha de entrenamiento","Falla de equipo","Escasez de material","Falla de planificaci√≥n","Falla de comunicaci√≥n","Recurrente ‚Äî sist√©mico","Anomal√≠a √∫nica"]
};
const GUIDE_QS = {
  "Team Leader":{en:["When a problem hits your line, do you fix it yourself or coach your team member to fix it?","Are there tasks you do today that a trained team member could own?","When you're in a meeting, who is watching your process?","How much of your shift is planned vs. reactive?","When did you last give structured feedback against a standard?"],es:["Cuando hay un problema, ¬ølo resuelves t√∫ o entrenas al miembro del equipo?","¬øHay tareas que un miembro entrenado podr√≠a hacer?","Cuando est√°s en reuni√≥n, ¬øqui√©n observa el proceso?","¬øCu√°nto de tu turno est√° planificado vs. reactivo?","¬øCu√°ndo diste retroalimentaci√≥n estructurada contra un est√°ndar?"]},
  "Supervisor":{en:["In your last gemba walk, were you observing/coaching TLs ‚Äî or fixing problems yourself?","Who owns your visual board data? If it's you, why?","Can you tell if your area is on-standard without walking the floor?","What % of your day is your standard work vs. firefighting?","When a TL brings a problem, do you solve it or coach them?","When did you last audit a TL's behavior ‚Äî not their results?"],es:["En tu √∫ltimo gemba walk, ¬øobservabas/entrenabas TLs o resolv√≠as problemas?","¬øQui√©n es due√±o de los datos del tablero?","¬øPuedes saber si tu √°rea est√° al est√°ndar sin caminar el piso?","¬øQu√© % de tu d√≠a es trabajo est√°ndar vs. apagando fuegos?","Cuando un TL trae un problema, ¬ølo resuelves o lo entrenas?","¬øCu√°ndo auditaste el comportamiento de un TL ‚Äî no sus resultados?"]},
  "Manager":{en:["How do you verify supervisors execute standard work ‚Äî not just hit numbers?","Are you in meetings your supervisors should own?","When did you last develop a supervisor's capability vs. solve their problem?","What's your process to identify a supervisor working below level?","Do you have a layered audit ‚Äî and are you the one closing it?"],es:["¬øC√≥mo verificas que supervisores ejecutan trabajo est√°ndar?","¬øEst√°s en reuniones que tus supervisores deber√≠an dirigir?","¬øCu√°ndo desarrollaste la capacidad de un supervisor vs. resolviste su problema?","¬øCu√°l es tu proceso para detectar un supervisor trabajando por debajo de su nivel?","¬øTienes auditor√≠a por capas ‚Äî y eres t√∫ quien la cierra?"]},
  "Team Member":{en:["Do you know the standard for your job ‚Äî and does it match what you actually do?","When something goes wrong, do you have a clear way to signal your team leader?","What slows you down most each shift?","Do you understand how your work connects to quality and delivery?"],es:["¬øConoces el est√°ndar para tu trabajo ‚Äî y coincide con lo que haces?","Cuando algo sale mal, ¬øtienes forma clara de se√±alizar al l√≠der?","¬øQu√© te frena m√°s en cada turno?","¬øEntiendes c√≥mo tu trabajo conecta con calidad y entrega?"]}
};
const WRONG_LEVEL = {
  "Team Leader":{en:["Running product to catch up","Pulling production reports","Handling HR directly","Making scheduling decisions","Attending management meetings"],es:["Correr producto para alcanzar ritmo","Extraer reportes de producci√≥n","Manejar RRHH directamente","Decisiones de programaci√≥n","Asistir a reuniones gerenciales"]},
  "Supervisor":{en:["Updating visual boards themselves","Fixing equipment hands-on","Doing TL coaching with team members","Building their own reports","Covering open headcount on line"],es:["Actualizar tableros ellos mismos","Reparar equipos manualmente","Hacer coaching de TL con miembros","Construir sus propios reportes","Cubrir plazas en la l√≠nea"]},
  "Manager":{en:["Attending Tier 1 floor meetings","Solving supervisor-level problems","Daily scheduling decisions","Building metrics reports","Handling individual team member issues"],es:["Asistir a reuniones Tier 1","Resolver problemas de supervisor","Decisiones diarias de programaci√≥n","Construir reportes de m√©tricas","Manejar problemas individuales de miembros"]},
  "Team Member":{
    en:["Being asked to make scheduling or quality disposition decisions","Covering another person's role without proper training","Solving equipment problems that require maintenance","Working without a clear standard to follow","Attending meetings that aren't relevant to your work"],
    es:["Tomar decisiones de programaci√≥n o disposici√≥n de calidad","Cubrir el rol de otra persona sin entrenamiento","Resolver problemas de equipo que requieren mantenimiento","Trabajar sin un est√°ndar claro a seguir","Asistir a reuniones que no son relevantes para tu trabajo"]
  }
};

const WATCH_COLORS = {Safety:"#ef4444",Seguridad:"#ef4444",Quality:"#f59e0b",Calidad:"#f59e0b",Delivery:"#3b82f6",Entrega:"#3b82f6",Cost:"#22c55e",Costo:"#22c55e"};

// ‚îÄ‚îÄ‚îÄ PRE-CANNED SUPERVISOR TEMPLATE (from uploaded form) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPERVISOR_TEMPLATE_EN = [
  // Morning
  {id:"t1",text:"Lead morning meeting ‚Äî review KPIs",freq:"Each Shift",timeOfDay:"Shift Start",duration:"15",owner:"Supervisor",standard:"Back-orders and truck returns are identified and team is aware of goals",auditTier:["Manager"],timeBin:"Start of Shift"},
  {id:"t2",text:"Startup Readiness communicated to teams ‚Äî People, Equipment, Parts",freq:"Each Shift",timeOfDay:"Shift Start",duration:"10",owner:"Supervisor",standard:"All 3 elements (People / Equipment / Parts) confirmed before production starts",auditTier:["Manager"],timeBin:"Start of Shift"},
  {id:"t3",text:"Spin Report reviewed and communicated",freq:"Each Shift",timeOfDay:"Shift Start",duration:"10",owner:"Supervisor",standard:"Spin report reviewed, action owners identified, team notified",auditTier:["Manager"],timeBin:"Start of Shift"},
  // During Day
  {id:"t4",text:"Critical to Quality Checks completed ‚Äî Pre-Break, Pre/Post Lunch",freq:"3x Daily",timeOfDay:"",duration:"10",owner:"Supervisor",standard:"CTQ checks completed at each interval per standard. Findings documented.",auditTier:["Manager"],timeBin:"Morning"},
  {id:"t5",text:"Standard Work Audit completed and actions documented",freq:"Daily",timeOfDay:"",duration:"20",owner:"Supervisor",standard:"At least 1 TL audited per shift. Non-conformances documented with owner and due date.",auditTier:["Manager"],timeBin:"Morning"},
  {id:"t6",text:"Problem Solving time slot used for daily problem solving",freq:"Daily",timeOfDay:"",duration:"30",owner:"Supervisor",standard:"Structured problem solving session held ‚Äî not firefighting. A3 or 5-why in use.",auditTier:["Manager"],timeBin:"Mid-Shift"},
  {id:"t7",text:"Time Cards updated",freq:"Daily",timeOfDay:"",duration:"10",owner:"Supervisor",standard:"All time cards current and accurate",auditTier:[],timeBin:"Mid-Shift"},
  {id:"t8",text:"Attendance Actions conducted as needed",freq:"As Needed",timeOfDay:"",duration:"",owner:"Supervisor",standard:"Policy followed, documented, HR notified if required",auditTier:["Manager"],timeBin:"Mid-Shift"},
  {id:"t9",text:"Back Orders and Truck Returns reviewed and progressing",freq:"Daily",timeOfDay:"",duration:"10",owner:"Supervisor",standard:"All back orders have action owner and target date. No aging > standard.",auditTier:["Manager"],timeBin:"Mid-Shift"},
  {id:"t10",text:"KPI Board Actions up to date ‚Äî action owner, due date, no late items",freq:"Daily",timeOfDay:"",duration:"10",owner:"Supervisor",standard:"All actions have owner and due date. Nothing past due without escalation.",auditTier:["Manager"],timeBin:"Mid-Shift"},
  {id:"t11",text:"Safety Audit completed and follow-up done with Committee Person",freq:"Daily",timeOfDay:"",duration:"15",owner:"Supervisor",standard:"Safety audit checklist completed. All findings have corrective action assigned.",auditTier:["Manager"],timeBin:"Mid-Shift"},
  {id:"t12",text:"Jeff Circle (Ohno Circle) ‚Äî structured observation completed for each TL",freq:"Weekly",dayOfWeek:"Friday",timeOfDay:"",duration:"60",owner:"Supervisor",standard:"Supervisor stands in circle and observes TL executing standard work. Observations documented ‚Äî what was followed, what wasn't, what coaching is needed. No intervention during observation.",auditTier:["Manager"],timeBin:"Weekly"},
  // End of Shift
  {id:"t13",text:"Red Tag Racks ‚Äî everything labeled and marked",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Supervisor",standard:"All red tag items identified, labeled, segregated. Nothing unlabeled.",auditTier:["Manager"],timeBin:"End of Shift"},
  {id:"t14",text:"Frame/Sash Remakes entered in remake tracker (QR Code)",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Supervisor",standard:"All remakes logged before shift end. No untracked remakes.",auditTier:["Manager"],timeBin:"End of Shift"},
  {id:"t15",text:"KPI Board updated with daily info",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Supervisor",standard:"All KPIs updated with actuals. Trends visible.",auditTier:["Manager"],timeBin:"End of Shift"},
  {id:"t16",text:"Back Orders reviewed ‚Äî all actioned",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Supervisor",standard:"All back orders reviewed. Action owners confirmed. Nothing un-actioned.",auditTier:["Manager"],timeBin:"End of Shift"},
  {id:"t17",text:"Hourly HPR Miss updates completed in Dashboard ‚Äî 'Red Hours'",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Supervisor",standard:"All red hours documented with reason code and corrective note in dashboard.",auditTier:["Manager"],timeBin:"End of Shift"},
];

const ES_TEXTS = {
  "t1":"Dirigir reuni√≥n matutina ‚Äî revisar KPIs",
  "t2":"Comunicar Preparaci√≥n de Arranque ‚Äî Personas, Equipo, Partes",
  "t3":"Reporte Spin revisado y comunicado",
  "t4":"Verificaciones Cr√≠ticas de Calidad ‚Äî Pre-Descanso, Pre/Post Almuerzo",
  "t5":"Auditor√≠a de Trabajo Est√°ndar completada y acciones documentadas",
  "t6":"Espacio de Resoluci√≥n de Problemas utilizado para resoluci√≥n diaria",
  "t7":"Tarjetas de Tiempo actualizadas",
  "t8":"Acciones de Asistencia realizadas seg√∫n necesidad",
  "t9":"√ìrdenes Pendientes y Devoluciones de Cami√≥n revisadas y progresando",
  "t10":"Acciones del Tablero KPI al d√≠a ‚Äî due√±o, fecha l√≠mite, sin atrasados",
  "t11":"Auditor√≠a de Seguridad completada y seguimiento con Persona del Comit√©",
  "t12":"Jeff Circle (C√≠rculo Ohno) ‚Äî observaci√≥n estructurada completada para cada TL",
  "t13":"Racks de Etiqueta Roja ‚Äî todo etiquetado y marcado",
  "t14":"Retrabajos de Marco/Sash ingresados en rastreador (C√≥digo QR)",
  "t15":"Tablero KPI actualizado con informaci√≥n diaria",
  "t16":"√ìrdenes Pendientes revisadas ‚Äî todas accionadas",
  "t17":"Actualizaciones horarias HPR Miss completadas en Dashboard ‚Äî 'Horas Rojas'"
};
const SUPERVISOR_TEMPLATE_ES = SUPERVISOR_TEMPLATE_EN.map(t=>({...t, text: ES_TEXTS[t.id]||t.text}));


// ‚îÄ‚îÄ‚îÄ MANAGER TEMPLATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MANAGER_TEMPLATE = [
  {id:"m1",text:"Tier 2 / Tier 3 meeting ‚Äî review department KPIs and escalations",freq:"Daily",timeOfDay:"Shift Start",duration:"20",owner:"Manager",standard:"Supervisors present data. Manager asks why, not what. Escalations have owners and dates.",auditTier:[],timeBin:"Start of Shift"},
  {id:"m2",text:"Gemba walk ‚Äî observe supervisors executing standard work (not results)",freq:"Daily",timeOfDay:"",duration:"30",owner:"Manager",standard:"At least 1 supervisor observed per day. Coaching notes documented. Not a firefighting walk.",auditTier:[],timeBin:"Morning"},
  {id:"m3",text:"Layered audit ‚Äî verify supervisor LSW completion",freq:"Daily",timeOfDay:"",duration:"20",owner:"Manager",standard:"Supervisor LSW signed off. Non-conformances logged with coaching follow-up within 24hrs.",auditTier:[],timeBin:"Morning"},
  {id:"m4",text:"Problem solving review ‚Äî verify A3s / 5-whys are progressing, not stalled",freq:"Daily",timeOfDay:"",duration:"20",owner:"Manager",standard:"Every open A3 has an owner, a next action, and a due date. Nothing stalled >3 days without escalation.",auditTier:[],timeBin:"Mid-Shift"},
  {id:"m5",text:"Supervisor 1:1 coaching ‚Äî development conversation (not firefighting debrief)",freq:"Weekly",dayOfWeek:"Wednesday",timeOfDay:"",duration:"45",owner:"Manager",standard:"Coaching against development plan, not daily issues. Supervisor owns the agenda. Manager asks questions.",auditTier:[],timeBin:"Weekly"},
  {id:"m6",text:"KPI trend review ‚Äî week over week, identify patterns not just daily misses",freq:"Weekly",dayOfWeek:"Monday",timeOfDay:"",duration:"30",owner:"Manager",standard:"Trend analysis, not point-in-time. Identify systemic issues. Action items have owners.",auditTier:[],timeBin:"Weekly"},
  {id:"m7",text:"Safety audit ‚Äî verify corrective actions closed from prior week",freq:"Weekly",dayOfWeek:"Friday",timeOfDay:"",duration:"20",owner:"Manager",standard:"All prior week safety actions verified closed or escalated. No aging open items.",auditTier:[],timeBin:"Weekly"},
  {id:"m8",text:"Capacity / staffing review ‚Äî next week readiness",freq:"Weekly",dayOfWeek:"Thursday",timeOfDay:"",duration:"20",owner:"Manager",standard:"People, equipment, materials confirmed for next week. Gaps identified and actioned before Friday.",auditTier:[],timeBin:"Weekly"},
];

// ‚îÄ‚îÄ‚îÄ TEAM LEADER TEMPLATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TL_TEMPLATE = [
  {id:"tl1",text:"Pre-shift check ‚Äî People, Parts, Equipment confirmed before production starts",freq:"Each Shift",timeOfDay:"Shift Start",duration:"10",owner:"Team Leader",standard:"All 3 elements confirmed. Any gap escalated to Supervisor before line starts. No surprises.",auditTier:["Supervisor"],timeBin:"Start of Shift"},
  {id:"tl2",text:"Team member assignment ‚Äî roles communicated to each person",freq:"Each Shift",timeOfDay:"Shift Start",duration:"5",owner:"Team Leader",standard:"Every team member knows their station and daily target before production starts.",auditTier:["Supervisor"],timeBin:"Start of Shift"},
  {id:"tl3",text:"Hourly production check ‚Äî actual vs. target, log misses immediately",freq:"Each Shift",timeOfDay:"",duration:"5",owner:"Team Leader",standard:"HPR board updated every hour. Misses logged with reason code in real time ‚Äî not end of shift.",auditTier:["Supervisor"],timeBin:"Morning"},
  {id:"tl4",text:"Quality check ‚Äî verify team members following standard work at workstation",freq:"Each Shift",timeOfDay:"",duration:"15",owner:"Team Leader",standard:"At least 1 structured observation per shift per zone. Deviations documented and coached ‚Äî not just fixed.",auditTier:["Supervisor"],timeBin:"Morning"},
  {id:"tl5",text:"5S audit ‚Äî walk zone and document condition",freq:"Daily",timeOfDay:"",duration:"10",owner:"Team Leader",standard:"Zone meets 5S standard. Items out of place returned or tagged. Score logged on visual board.",auditTier:["Supervisor"],timeBin:"Mid-Shift"},
  {id:"tl6",text:"Problem escalation ‚Äî issues beyond TL authority raised to Supervisor with data",freq:"As Needed",timeOfDay:"",duration:"",owner:"Team Leader",standard:"Problem described with: what happened, when, how many affected, what TL already tried. Not just 'we have a problem'.",auditTier:[],timeBin:"Mid-Shift"},
  {id:"tl7",text:"Team member feedback ‚Äî structured coaching against standard (not just correction)",freq:"Daily",timeOfDay:"",duration:"10",owner:"Team Leader",standard:"At least 1 team member receives specific, standard-referenced feedback per shift. Positive and developmental.",auditTier:["Supervisor"],timeBin:"Mid-Shift"},
  {id:"tl8",text:"End of shift handoff ‚Äî communicate open issues, production status, next shift priorities",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Team Leader",standard:"Incoming TL knows: production status, open issues, any equipment concerns, staffing gaps.",auditTier:["Supervisor"],timeBin:"End of Shift"},
  {id:"tl9",text:"Visual board update ‚Äî actuals, misses, and actions documented",freq:"Each Shift",timeOfDay:"End of Shift",duration:"10",owner:"Team Leader",standard:"All metrics updated with actuals. Trend visible. Actions have owner and due date.",auditTier:["Supervisor"],timeBin:"End of Shift"},
];

const uid = () => Math.random().toString(36).slice(2,9);

// ‚îÄ‚îÄ‚îÄ AI COACH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getAICoaching(context, lang) {
  const sys = lang==="es"
    ? "Eres un consultor Lean con cintur√≥n negro Six Sigma. Das retroalimentaci√≥n directa y pr√°ctica a l√≠deres de manufactura. Se√±ala trabajo en nivel incorrecto, patrones de apagado de fuegos, y haz preguntas de sondeo. M√°ximo 4 oraciones."
    : "You are a senior Lean consultant and Six Sigma Black Belt coaching manufacturing leaders. Give direct, practical feedback. Call out wrong-level work, firefighting patterns, ask one probing follow-up question. Max 4 sentences.";
  try {
    const r = await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,system:sys,messages:[{role:"user",content:context}]})});
    const d = await r.json();
    if(d.error) return lang==="es"?"Coach IA disponible solo dentro de Claude.ai":"AI Coach available inside Claude.ai only ‚Äî use the Guide tab reflections for coaching prompts";
    return d.content?.[0]?.text||"";
  } catch(e) { return lang==="es"?"Coach IA disponible solo dentro de Claude.ai":"AI Coach available inside Claude.ai only ‚Äî use the Guide tab reflections for coaching prompts"; }
}

// ‚îÄ‚îÄ‚îÄ EXPORT HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dlBlob=(blob,name)=>{const a=Object.assign(document.createElement("a"),{href:URL.createObjectURL(blob),download:name});a.click();URL.revokeObjectURL(a.href);};

const freqLabel=(r)=>{
  let f=r.freq||"";
  if((f==="Weekly"||f==="Semanal")&&r.dayOfWeek) f+=` (${r.dayOfWeek})`;
  if((f==="Monthly"||f==="Mensual")&&r.dayOfMonth) f+=` Day ${r.dayOfMonth}`;
  return f;
};

// ‚îÄ‚îÄ‚îÄ PDF TRIFOLD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const exportPDFTrifold=(tasks,required,watchItems,level,lang,t,levelAccent)=>{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:"landscape",unit:"mm",format:"letter"});
  const W=279.4,H=215.9,PW=W/3;
  const PAD=5,FW=PW-(PAD*2);
  const NAVY=[20,40,80],WHITE=[255,255,255],LIGHT=[248,250,252];
  const BORDER=[203,213,225],TEXT=[30,41,59],MUTED=[100,116,139],BLUE=[37,99,235];
  const GREEN=[22,163,74],RED=[220,38,38];
  const dateStr=new Date().toLocaleDateString(lang==="es"?"es-MX":"en-US",{month:"short",day:"numeric",year:"numeric"});
  const levelName=LL[level]?.[lang]||level;

  const panelBg=(x)=>{doc.setFillColor(...WHITE);doc.rect(x,0,PW,H,"F");doc.setDrawColor(...BORDER);doc.setLineWidth(0.3);doc.line(x+PW,0,x+PW,H);};
  const hdr=(x,text,sub)=>{
    doc.setFillColor(...NAVY);doc.rect(x,0,PW,12,"F");
    doc.setTextColor(...WHITE);doc.setFont("helvetica","bold");doc.setFontSize(9);
    doc.text(text,x+PW/2,5.5,{align:"center"});
    if(sub){doc.setFontSize(6);doc.setFont("helvetica","normal");doc.text(sub,x+PW/2,9.5,{align:"center"});}
  };
  const lbl=(text,x,y)=>{doc.setFont("helvetica","bold");doc.setFontSize(6);doc.setTextColor(...MUTED);doc.text(text.toUpperCase(),x,y);};
  const line=(x,y,w)=>{doc.setDrawColor(...BORDER);doc.setLineWidth(0.3);doc.line(x,y,x+w,y);};
  const box=(x,y,w,h)=>{doc.setDrawColor(...BORDER);doc.setLineWidth(0.2);doc.setFillColor(...LIGHT);doc.roundedRect(x,y,w,h,1,1,"FD");};
  const body=(text,x,y,mw,sz=8)=>{
    if(!text)return;
    doc.setFont("helvetica","normal");doc.setFontSize(sz);doc.setTextColor(...TEXT);
    doc.text(doc.splitTextToSize(String(text),mw),x,y);
  };

  // ‚îÄ‚îÄ PANEL 1: FRONT COVER ‚îÄ‚îÄ
  panelBg(0);hdr(0,t.appTitle,t.lswTitle||"Daily Standard Work");
  let y=16;
  lbl(lang==="es"?"NIVEL":"LEVEL",PAD,y);y+=3;
  doc.setFont("helvetica","bold");doc.setFontSize(11);doc.setTextColor(...NAVY);
  doc.text(levelName,PAD,y);line(PAD,y+1,FW);y+=7;
  lbl(lang==="es"?"FECHA":"DATE",PAD,y);lbl(lang==="es"?"TURNO":"SHIFT",PAD+FW/2,y);y+=3;
  line(PAD,y+1,FW/2-2);line(PAD+FW/2,y+1,FW/2);y+=7;
  lbl(lang==="es"?"NOMBRE DEL L√çDER":"LEADER NAME",PAD,y);y+=3;
  line(PAD,y+1,FW);y+=7;
  lbl(lang==="es"?"DEPARTAMENTO / L√çNEA":"DEPARTMENT / LINE",PAD,y);y+=3;
  line(PAD,y+1,FW);y+=8;
  lbl(lang==="es"?"PROBLEMAS / NOTAS DEL D√çA":"DAILY ISSUES / NOTES",PAD,y);y+=3;
  box(PAD,y,FW,30);y+=34;
  lbl(lang==="es"?"FIRMA":"SIGNATURE",PAD,y);y+=3;
  doc.setDrawColor(...NAVY);doc.setLineWidth(0.5);doc.line(PAD,y,PAD+FW,y);y+=10;
  // SQDC
  lbl("SQDC STATUS",PAD,y);y+=3;
  const sqW=(FW-6)/4;
  [{l:"S",c:[239,68,68],n:"Safety"},{l:"Q",c:[245,158,11],n:"Quality"},{l:"D",c:[59,130,246],n:"Delivery"},{l:"C",c:[34,197,94],n:"Cost"}].forEach((s,i)=>{
    const sx=PAD+(i*(sqW+2));
    doc.setDrawColor(...s.c);doc.setFillColor(250,250,250);doc.roundedRect(sx,y,sqW,10,1,1,"FD");
    doc.setTextColor(...s.c);doc.setFont("helvetica","bold");doc.setFontSize(8);doc.text(s.l,sx+sqW/2,y+4.5,{align:"center"});
    doc.setFontSize(5);doc.setFont("helvetica","normal");doc.text(s.n,sx+sqW/2,y+8.5,{align:"center"});
  });

  // ‚îÄ‚îÄ PANEL 2: TODAY'S STANDARD WORK (Required + Maintain tasks) ‚îÄ‚îÄ
  const p2x=PW;
  panelBg(p2x);hdr(p2x,lang==="es"?"TRABAJO EST√ÅNDAR DE HOY":"TODAY'S STANDARD WORK",dateStr);
  y=16;
  // Column headers
  doc.setFont("helvetica","bold");doc.setFontSize(6);doc.setTextColor(...MUTED);
  doc.text(lang==="es"?"HORA":"TIME",p2x+PAD,y);
  doc.text("‚úì",p2x+PAD+16,y);
  doc.text(lang==="es"?"TAREA":"TASK",p2x+PAD+22,y);
  doc.text(lang==="es"?"FREC":"FREQ",p2x+PW-PAD-12,y,{align:"right"});
  doc.setDrawColor(...BORDER);doc.line(p2x+PAD,y+2,p2x+PW-PAD,y+2);y+=5;

  const ROW=8;
  const maxRows=Math.floor((H-y-4)/ROW);
  // Combine required items and maintain tasks into schedule
  const schedItems=[
    ...required.map(r=>({time:r.timeOfDay||"",task:r.text,freq:freqLabel(r),isRequired:true})),
    ...tasks.filter(x=>x.disposition==="MAINTAIN").map(x=>({time:x.timeBin||"",task:x.description,freq:"",isRequired:false}))
  ].slice(0,maxRows);
  const emptyRows=Math.max(0,maxRows-schedItems.length);

  schedItems.forEach((item,i)=>{
    const ry=y+(i*ROW);
    if(i%2===0){doc.setFillColor(248,250,252);doc.rect(p2x+PAD,ry-2.5,FW,ROW,"F");}
    doc.setFont("helvetica","bold");doc.setFontSize(6.5);doc.setTextColor(...BLUE);
    doc.text(item.time||"‚Äî",p2x+PAD,ry+1);
    doc.setDrawColor(...BORDER);doc.setLineWidth(0.3);doc.rect(p2x+PAD+14,ry-1.5,3.5,3.5,"S");
    doc.setFont("helvetica","normal");doc.setFontSize(6.5);doc.setTextColor(...TEXT);
    const tl=doc.splitTextToSize(item.task||"",FW-34);
    doc.text(tl[0]||"",p2x+PAD+20,ry+1);
    if(item.freq){doc.setFontSize(5.5);doc.setTextColor(...MUTED);doc.text(item.freq,p2x+PW-PAD-1,ry+1,{align:"right"});}
    doc.setDrawColor(...BORDER);doc.setLineWidth(0.1);doc.line(p2x+PAD,ry+ROW-2,p2x+PW-PAD,ry+ROW-2);
  });
  for(let i=0;i<emptyRows;i++){
    const ry=y+((schedItems.length+i)*ROW);
    if((schedItems.length+i)%2===0){doc.setFillColor(248,250,252);doc.rect(p2x+PAD,ry-2.5,FW,ROW,"F");}
    doc.setDrawColor(...BORDER);doc.setLineWidth(0.3);doc.rect(p2x+PAD+14,ry-1.5,3.5,3.5,"S");
    doc.line(p2x+PAD+20,ry+1,p2x+PW-PAD-14,ry+1);
    doc.setLineWidth(0.1);doc.line(p2x+PAD,ry+ROW-2,p2x+PW-PAD,ry+ROW-2);
  }

  // ‚îÄ‚îÄ PANEL 3: REFLECTION & CRITICAL WATCH ‚îÄ‚îÄ
  const p3x=PW*2;
  panelBg(p3x);hdr(p3x,lang==="es"?"REFLEXI√ìN Y NOTAS":"REFLECTION & NOTES");
  y=16;
  const refSections=[
    {icon:"‚úì",lbl:lang==="es"?"¬øQU√â SALI√ì BIEN?":"WHAT WENT WELL?",h:28},
    {icon:"‚ö†",lbl:lang==="es"?"¬øQU√â PROBLEMAS SURGIERON?":"WHAT ISSUES SURFACED?",h:28},
    {icon:"‚Üí",lbl:lang==="es"?"SEGUIMIENTOS NECESARIOS":"FOLLOW-UPS NEEDED",h:22},
    {icon:"üí°",lbl:lang==="es"?"IDEA DE MEJORA":"IMPROVEMENT IDEA",h:22},
  ];
  refSections.forEach(s=>{
    doc.setFont("helvetica","bold");doc.setFontSize(6.5);doc.setTextColor(...NAVY);
    doc.text(s.icon+" "+s.lbl,p3x+PAD,y);y+=3;
    box(p3x+PAD,y,FW,s.h);
    // lined writing area inside box
    for(let i=1;i<Math.floor(s.h/7);i++){doc.setDrawColor(220,230,240);doc.setLineWidth(0.1);doc.line(p3x+PAD+2,y+(i*7),p3x+PW-PAD-2,y+(i*7));}
    y+=s.h+4;
  });
  // Watch items summary if any
  if(watchItems.length>0&&y<H-20){
    lbl(lang==="es"?"VIGILANCIA CR√çTICA ‚Äî ALERTAS":"CRITICAL WATCH ‚Äî ALERTS",p3x+PAD,y);y+=3;
    watchItems.slice(0,4).forEach(w=>{
      if(y>H-8)return;
      doc.setFont("helvetica","bold");doc.setFontSize(6);doc.setTextColor(...RED);
      doc.text("‚óè",p3x+PAD,y);
      doc.setFont("helvetica","normal");doc.setTextColor(...TEXT);
      const wl=doc.splitTextToSize(w.text+(w.threshold?" ‚Äî "+w.threshold:""),FW-5);
      doc.text(wl[0],p3x+PAD+4,y);y+=5;
    });
  }

  // ‚îÄ‚îÄ PAGE 2: ACTION ITEMS (back panel when printed double-sided) ‚îÄ‚îÄ
  doc.addPage();
  doc.setFillColor(...WHITE);doc.rect(0,0,W,H,"F");
  doc.setFillColor(...NAVY);doc.rect(0,0,W,12,"F");
  doc.setTextColor(...WHITE);doc.setFont("helvetica","bold");doc.setFontSize(10);
  doc.text((lang==="es"?"ACCIONES / CONTRAMEDIDAS ‚Äî ":"ACTION ITEMS / COUNTERMEASURES ‚Äî ")+levelName,W/2,7.5,{align:"center"});

  // Firefighting items
  const ff=tasks.filter(x=>x.isFirefighting);
  const push=tasks.filter(x=>x.disposition==="PUSH_DOWN"&&!x.isFirefighting);
  const cols=[55,50,55,35,25,25,22];
  const hdrs=lang==="es"
    ?["PROBLEMA","CAUSA RA√çZ","ACCI√ìN","RESPONSABLE","FECHA","CATEGOR√çA","ESTADO"]
    :["PROBLEM / DESCRIPTION","ROOT CAUSE","ACTION / COUNTERMEASURE","OWNER","DUE","CATEGORY","STATUS"];
  const cX=[4];cols.forEach((c,i)=>{if(i<cols.length-1)cX.push(cX[cX.length-1]+c);});
  y=17;
  doc.setFillColor(241,245,249);doc.rect(4,y-4,W-8,7,"F");
  hdrs.forEach((h,i)=>{doc.setFont("helvetica","bold");doc.setFontSize(6);doc.setTextColor(...MUTED);doc.text(h,cX[i]+1,y);});
  doc.setDrawColor(...BORDER);doc.line(4,y+2,W-4,y+2);y+=5;

  const aROW=9;
  const allActions=[
    ...ff.map(x=>({prob:x.description,cause:x.firefightingCause||"",action:x.firefightingNote||"",owner:"",due:"",cat:"üî• FF",status:"Open"})),
    ...push.map(x=>({prob:x.description,cause:"",action:x.pushNote||"",owner:LL[x.pushToLevel]?.[lang]||x.pushToLevel||"",due:"",cat:"‚Üì Push",status:"Open"})),
  ];
  const maxA=Math.floor((H-y-4)/aROW);
  const emptyA=Math.max(0,15-allActions.length);
  [...allActions.slice(0,maxA)].forEach((a,i)=>{
    if(i%2===0){doc.setFillColor(248,250,252);doc.rect(4,y-2.5,W-8,aROW,"F");}
    [a.prob,a.cause,a.action,a.owner,a.due,a.cat,a.status].forEach((v,ci)=>{
      doc.setFont("helvetica","normal");doc.setFontSize(7);doc.setTextColor(...TEXT);
      const vl=doc.splitTextToSize(v||"",cols[ci]-2);doc.text(vl[0]||"",cX[ci]+1,y+1);
    });
    doc.setDrawColor(...BORDER);doc.setLineWidth(0.1);doc.line(4,y+aROW-2,W-4,y+aROW-2);y+=aROW;
  });
  for(let i=0;i<Math.min(emptyA,maxA-allActions.length);i++){
    if((allActions.length+i)%2===0){doc.setFillColor(248,250,252);doc.rect(4,y-2.5,W-8,aROW,"F");}
    doc.setDrawColor(...BORDER);doc.setLineWidth(0.1);doc.line(4,y+aROW-2,W-4,y+aROW-2);y+=aROW;
  }

  const fname=`LSW_Trifold_${levelName.replace(/\s/g,"_")}_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(fname);
};

// ‚îÄ‚îÄ‚îÄ EXCEL TRIFOLD (CSV with panel structure) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const exportExcelTrifold=(tasks,required,watchItems,level,lang,t)=>{
  const levelName=LL[level]?.[lang]||level;
  const dateStr=new Date().toLocaleDateString(lang==="es"?"es-MX":"en-US");
  const q=s=>'"'+String(s||"").replace(/"/g,'""')+'"';
  const rows=[];

  // Build three column arrays (one per panel)
  const p1=[],p2=[],p3=[];

  // Panel 1 header
  p1.push(lang==="es"?"TRABAJO EST√ÅNDAR DEL L√çDER":"LEADER STANDARD WORK");
  p1.push(levelName);p1.push(dateStr);p1.push("");
  p1.push(lang==="es"?"NOMBRE:":"NAME:");p1.push("_________________________");
  p1.push(lang==="es"?"DEPARTAMENTO:":"DEPT:");p1.push("_________________________");
  p1.push(lang==="es"?"TURNO:":"SHIFT:");p1.push("_________________________");
  p1.push(lang==="es"?"FIRMA:":"SIGNATURE:");p1.push("_________________________");
  p1.push("");
  p1.push(lang==="es"?"PROBLEMAS / NOTAS:":"DAILY ISSUES / NOTES:");
  p1.push(""); p1.push(""); p1.push(""); p1.push(""); p1.push("");

  // Panel 2 header + schedule
  p2.push(lang==="es"?"TRABAJO EST√ÅNDAR DE HOY":"TODAY'S STANDARD WORK");
  p2.push(lang==="es"?"HORA | ‚úì | TAREA | FRECUENCIA":"TIME | ‚úì | TASK | FREQUENCY");
  p2.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  required.forEach(r=>{p2.push(`${r.timeOfDay||"‚Äî"} | ‚òê | ${r.text} | ${freqLabel(r)}`);});
  tasks.filter(x=>x.disposition==="MAINTAIN").forEach(x=>{p2.push(`${x.timeBin||"‚Äî"} | ‚òê | ${x.description} |`);});
  while(p2.length<p1.length+5)p2.push("       | ‚òê |                              |");

  // Panel 3 header + reflection
  p3.push(lang==="es"?"REFLEXI√ìN Y NOTAS":"REFLECTION & NOTES");
  p3.push("");
  p3.push(lang==="es"?"‚úì ¬øQU√â SALI√ì BIEN?":"‚úì WHAT WENT WELL?");
  p3.push(""); p3.push(""); p3.push(""); p3.push("");
  p3.push(lang==="es"?"‚ö† ¬øQU√â PROBLEMAS SURGIERON?":"‚ö† WHAT ISSUES SURFACED?");
  p3.push(""); p3.push(""); p3.push(""); p3.push("");
  p3.push(lang==="es"?"‚Üí SEGUIMIENTOS NECESARIOS":"‚Üí FOLLOW-UPS NEEDED");
  p3.push(""); p3.push(""); p3.push("");
  p3.push(lang==="es"?"üí° IDEA DE MEJORA":"üí° IMPROVEMENT IDEA");
  p3.push(""); p3.push("");

  // Zip three columns
  const maxLen=Math.max(p1.length,p2.length,p3.length);
  rows.push([q(lang==="es"?"PANEL 1 ‚Äî PORTADA":"PANEL 1 ‚Äî FRONT COVER"),
             q(lang==="es"?"PANEL 2 ‚Äî TRABAJO EST√ÅNDAR":"PANEL 2 ‚Äî STANDARD WORK"),
             q(lang==="es"?"PANEL 3 ‚Äî REFLEXI√ìN":"PANEL 3 ‚Äî REFLECTION")].join(","));
  for(let i=0;i<maxLen;i++){
    rows.push([q(p1[i]||""),q(p2[i]||""),q(p3[i]||"")].join(","));
  }

  // Back panel ‚Äî action items
  rows.push("","","");
  rows.push([q(lang==="es"?"PANEL TRASERO ‚Äî ACCIONES / CONTRAMEDIDAS":"BACK PANEL ‚Äî ACTION ITEMS / COUNTERMEASURES"),"",""].join(","));
  rows.push([q(lang==="es"?"PROBLEMA":"PROBLEM"),q(lang==="es"?"CAUSA RA√çZ":"ROOT CAUSE"),q(lang==="es"?"ACCI√ìN":"ACTION"),q(lang==="es"?"RESPONSABLE":"OWNER"),q(lang==="es"?"FECHA":"DUE"),q("STATUS")].join(","));
  const ff=tasks.filter(x=>x.isFirefighting);
  const push=tasks.filter(x=>x.disposition==="PUSH_DOWN"&&!x.isFirefighting);
  [...ff,...push].forEach(x=>{
    rows.push([q(x.description),q(x.firefightingCause||""),q(x.firefightingNote||x.pushNote||""),q(LL[x.pushToLevel]?.[lang]||""),q(""),q(x.isFirefighting?"üî•":"‚Üì")].join(","));
  });
  for(let i=0;i<Math.max(0,8-ff.length-push.length);i++){
    rows.push(["""","""","""","""","""",""Open""].join(","));
  }

  const csv=rows.join("\r\n");
  const BOM="\uFEFF";
  dlBlob(new Blob([BOM+csv],{type:"text/csv;charset=utf-8;"}),
    `LSW_Trifold_${levelName.replace(/\s/g,"_")}_${new Date().toISOString().slice(0,10)}.csv`);
};

// ‚îÄ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S={
  label:{display:"block",fontSize:10,letterSpacing:1.5,color:"#94a3b8",marginBottom:5,fontWeight:700},
  input:{width:"100%",background:"#111827",border:"1px solid #374151",color:"#f9fafb",borderRadius:6,padding:"8px 10px",fontSize:13,fontFamily:"inherit",outline:"none"},
  pill:{background:"transparent",border:"1px solid #374151",color:"#94a3b8",borderRadius:20,padding:"5px 12px",cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:700},
  card:{background:"#0f172a",border:"1px solid #1f2937",borderRadius:10,marginBottom:10},
  ab:{background:"#0a0f1a",border:"1px solid",borderRadius:10,padding:16,marginBottom:14},
};

// ‚îÄ‚îÄ‚îÄ TASK CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TaskCard({task,onUpdate,onDelete,level,lang,t,autoOpen}){
  const [open,setOpen]=useState(!!autoOpen);
  const [aiResp,setAiResp]=useState("");
  const [aiLoad,setAiLoad]=useState(false);
  const d=task.disposition?DISPOSITIONS[task.disposition]:null;
  const accent=LC[level];
  const timeBins=T[lang].timeBins;

  const runAI=async()=>{
    setAiLoad(true);setAiResp("");
    const ctx=`Leader level: ${LL[level]?.en}. Task: "${task.description}". Category: ${task.category||"none"}. Time: ${task.minutes||"?"}min. Firefighting?: ${task.isFirefighting?"Yes":"No"}. ${task.firefightingCause?`Root cause: ${task.firefightingCause}.`:""} Disposition: ${task.disposition?DISPOSITIONS[task.disposition]?.en:"unclassified"}. ${task.notes?`Notes: ${task.notes}`:""}.`;
    const r=await getAICoaching(ctx,lang);
    setAiResp(r||t.aiError);setAiLoad(false);
  };

  return(
    <div style={{...S.card,border:`1px solid ${d?d.color+"55":"#1f2937"}`,transition:"border-color 0.3s"}}>
      <div style={{padding:"12px 16px",cursor:"pointer",display:"flex",alignItems:"center",gap:10}} onClick={()=>setOpen(!open)}>
        <div style={{flex:1}}>
          <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",marginBottom:3}}>
            <span style={{fontSize:13,color:"#f9fafb",fontWeight:500}}>{task.description||<em style={{color:"#4b5563"}}>...</em>}</span>
            {task.isFirefighting&&<span style={{fontSize:10,background:"#7c2d1222",color:"#f97316",border:"1px solid #f9731644",padding:"1px 7px",borderRadius:3,fontWeight:700}}>üî•</span>}
          </div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            {task.category&&<span style={{fontSize:11,color:"#6b7280"}}>{task.category}</span>}
            {task.minutes>0&&<span style={{fontSize:11,color:"#6b7280"}}>¬∑ {task.minutes}min</span>}
            {task.timeBin&&<span style={{fontSize:11,color:"#6b7280"}}>¬∑ {task.timeBin}</span>}
          </div>
        </div>
        <div style={{display:"flex",gap:6,alignItems:"center"}}>
          {d&&<span style={{background:d.bg,color:d.color,border:`1px solid ${d.color}88`,padding:"3px 9px",borderRadius:4,fontSize:11,fontWeight:700,whiteSpace:"nowrap"}}>{d.icon} {d[lang]}</span>}
          <span style={{color:"#4b5563",fontSize:11}}>{open?"‚ñ≤":"‚ñº"}</span>
        </div>
      </div>
      {open&&(
        <div style={{padding:"0 16px 16px",borderTop:"1px solid #1f2937"}}>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:10,marginTop:14}}>
            <div style={{gridColumn:"1/-1"}}>
              <label style={S.label}>{t.description}</label>
              <input style={S.input} value={task.description} onChange={e=>onUpdate({...task,description:e.target.value})}/>
            </div>
            <div>
              <label style={S.label}>{t.category}</label>
              <select style={S.input} value={task.category} onChange={e=>onUpdate({...task,category:e.target.value})}>
                <option value="">{t.selectCat}</option>
                {CATS[lang].map(c=><option key={c}>{c}</option>)}
              </select>
            </div>
            <div>
              <label style={S.label}>{t.timeSpent}</label>
              <input style={S.input} type="number" value={task.minutes||""} onChange={e=>onUpdate({...task,minutes:parseInt(e.target.value)||0})} placeholder="0"/>
            </div>
            <div>
              <label style={S.label}>{t.timeBin}</label>
              <select style={S.input} value={task.timeBin||""} onChange={e=>onUpdate({...task,timeBin:e.target.value})}>
                <option value="">{t.selectCat}</option>
                {timeBins.map(b=><option key={b}>{b}</option>)}
              </select>
            </div>
            <div>
              <label style={S.label}>{t.whoInvolved}</label>
              <input style={S.input} value={task.owner||""} onChange={e=>onUpdate({...task,owner:e.target.value})}/>
            </div>
          </div>
          <div style={{marginTop:12}}>
            <label style={S.label}>{t.isFF}</label>
            <div style={{display:"flex",gap:8}}>
              {[t.yes,t.no].map((v,i)=>(
                <button key={v} onClick={()=>onUpdate({...task,isFirefighting:i===0})}
                  style={{...S.pill,...(task.isFirefighting===(i===0)?{background:"#7c2d1266",color:"#f97316",borderColor:"#f97316"}:{})}}>{v}</button>
              ))}
            </div>
          </div>
          {task.isFirefighting&&(
            <div style={{marginTop:12,background:"#1c0a0288",border:"1px solid #f9731644",borderRadius:8,padding:14}}>
              <label style={{...S.label,color:"#f97316"}}>üî• {t.ffCause}</label>
              <div style={{display:"flex",flexWrap:"wrap",gap:6,marginTop:6}}>
                {FF_CAUSES[lang].map(c=>(
                  <button key={c} onClick={()=>onUpdate({...task,firefightingCause:c})}
                    style={{...S.pill,fontSize:10,...(task.firefightingCause===c?{background:"#7c2d1266",color:"#f97316",borderColor:"#f97316"}:{})}}>{c}</button>
                ))}
              </div>
              <textarea style={{...S.input,marginTop:10,height:56,resize:"vertical"}} value={task.firefightingNote||""} onChange={e=>onUpdate({...task,firefightingNote:e.target.value})} placeholder={t.ffNote}/>
            </div>
          )}
          <div style={{marginTop:12}}>
            <label style={S.label}>{t.disposition}</label>
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {Object.entries(DISPOSITIONS).map(([k,d])=>(
                <button key={k} onClick={()=>onUpdate({...task,disposition:k})}
                  style={{...S.pill,...(task.disposition===k?{background:d.bg,color:d.color,borderColor:d.color}:{})}}>{d.icon} {d[lang]}</button>
              ))}
            </div>
            {task.disposition==="PUSH_DOWN"&&(
              <div style={{marginTop:10,background:"#1c100288",border:"1px solid #d9770644",borderRadius:6,padding:12}}>
                <label style={{...S.label,color:"#d97706"}}>{t.pushTo}</label>
                <select style={S.input} value={task.pushToLevel||""} onChange={e=>onUpdate({...task,pushToLevel:e.target.value})}>
                  <option value="">{t.selectLevel}</option>
                  {LEVELS.map(l=><option key={l} value={l}>{LL[l][lang]}</option>)}
                </select>
                <textarea style={{...S.input,marginTop:8,height:50,resize:"vertical"}} value={task.pushNote||""} onChange={e=>onUpdate({...task,pushNote:e.target.value})} placeholder={t.pushNote}/>
              </div>
            )}
            {task.disposition==="ELIMINATE"&&(
              <textarea style={{...S.input,marginTop:8,height:50,resize:"vertical"}} value={task.eliminateNote||""} onChange={e=>onUpdate({...task,eliminateNote:e.target.value})} placeholder={t.eliminateNote}/>
            )}
          </div>
          <div style={{marginTop:12}}>
            <label style={S.label}>{t.notes}</label>
            <textarea style={{...S.input,height:54,resize:"vertical"}} value={task.notes||""} onChange={e=>onUpdate({...task,notes:e.target.value})}/>
          </div>
          <div style={{marginTop:14,background:"#0a0f1a",border:`1px solid ${accent}44`,borderRadius:8,padding:12}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:aiResp?8:0}}>
              <span style={{fontSize:10,letterSpacing:2,color:accent,fontWeight:700}}>‚ú¶ {t.aiCoach}</span>
              <button onClick={runAI} disabled={aiLoad} style={{background:accent+"22",border:`1px solid ${accent}66`,color:accent,borderRadius:6,padding:"5px 12px",cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:"inherit",opacity:aiLoad?0.6:1}}>
                {aiLoad?t.aiThinking:t.aiCoachBtn}
              </button>
            </div>
            {aiResp&&<p style={{fontSize:12,color:"#cbd5e1",lineHeight:1.7,marginTop:8,borderTop:`1px solid ${accent}33`,paddingTop:8}}>{aiResp}</p>}
          </div>
          <button onClick={onDelete} style={{marginTop:10,background:"transparent",border:"1px solid #dc262644",color:"#dc2626",borderRadius:6,padding:"5px 12px",cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>{t.remove}</button>
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ REQUIRED CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function RequiredCard({item,onUpdate,onDelete,lang,t,accent}){
  const [editing,setEditing]=useState(false);
  const [draft,setDraft]=useState({...item,auditTier:item.auditTier||[]});
  const save=()=>{onUpdate(draft);setEditing(false);};
  const toggleAudit=l=>setDraft(p=>({...p,auditTier:p.auditTier.includes(l)?p.auditTier.filter(x=>x!==l):[...p.auditTier,l]}));

  const freqLabel=()=>{
    let f=item.freq||"";
    if((f==="Weekly"||f==="Semanal")&&item.dayOfWeek) f+=` ¬∑ ${item.dayOfWeek}`;
    if((f==="Monthly"||f==="Mensual")&&item.dayOfMonth) f+=` ¬∑ Day ${item.dayOfMonth}`;
    return f;
  };

  if(!editing) return(
    <div style={{...S.card,padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10}}>
      <div style={{flex:1}}>
        <div style={{fontSize:13,color:"#f9fafb",fontWeight:500,marginBottom:5}}>{item.text}</div>
        <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:item.standard?4:0}}>
          {item.freq&&<span style={{fontSize:10,background:accent+"22",color:accent,border:`1px solid ${accent}44`,padding:"2px 8px",borderRadius:3}}>{freqLabel()}</span>}
          {item.timeOfDay&&<span style={{fontSize:11,color:"#6b7280"}}>‚è∞ {item.timeOfDay}</span>}
          {item.duration&&<span style={{fontSize:11,color:"#6b7280"}}>¬∑ {item.duration}min</span>}
          {item.owner&&<span style={{fontSize:11,color:"#6b7280"}}>¬∑ {item.owner}</span>}
          {item.auditTier?.length>0&&<span style={{fontSize:10,color:"#a855f7",background:"#a855f722",border:"1px solid #a855f744",padding:"2px 8px",borderRadius:3}}>üèó {item.auditTier.join(", ")}</span>}
        </div>
        {item.standard&&<div style={{fontSize:11,color:"#475569",fontStyle:"italic"}}>‚Üí {item.standard}</div>}
      </div>
      <div style={{display:"flex",gap:6,flexShrink:0}}>
        <button onClick={()=>setEditing(true)} style={{...S.pill,fontSize:10,padding:"4px 10px"}}>{t.editActivity}</button>
        <button onClick={onDelete} style={{background:"transparent",border:"none",color:"#4b5563",cursor:"pointer",fontSize:16}}>‚úï</button>
      </div>
    </div>
  );

  const isWeekly=(draft.freq==="Weekly"||draft.freq==="Semanal");
  const isMonthly=(draft.freq==="Monthly"||draft.freq==="Mensual");

  return(
    <div style={{...S.card,padding:16,border:`1px solid ${accent}55`}}>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:10}}>
        <div style={{gridColumn:"1/-1"}}>
          <label style={S.label}>{t.description}</label>
          <input style={S.input} value={draft.text} onChange={e=>setDraft(p=>({...p,text:e.target.value}))}/>
        </div>
        <div>
          <label style={S.label}>{t.freq}</label>
          <select style={S.input} value={draft.freq||""} onChange={e=>setDraft(p=>({...p,freq:e.target.value}))}>
            <option value="">{t.selectCat}</option>
            {t.freqOpts.map(f=><option key={f}>{f}</option>)}
          </select>
        </div>
        {isWeekly&&(
          <div>
            <label style={S.label}>{t.dayOfWeek}</label>
            <select style={S.input} value={draft.dayOfWeek||""} onChange={e=>setDraft(p=>({...p,dayOfWeek:e.target.value}))}>
              <option value="">{t.selectCat}</option>
              {t.weekdays.map(d=><option key={d}>{d}</option>)}
            </select>
          </div>
        )}
        {isMonthly&&(
          <div>
            <label style={S.label}>{t.dayOfMonth}</label>
            <input style={S.input} type="number" min={1} max={31} value={draft.dayOfMonth||""} onChange={e=>setDraft(p=>({...p,dayOfMonth:e.target.value}))} placeholder="1‚Äì31"/>
          </div>
        )}
        <div>
          <label style={S.label}>{t.timeOfDay}</label>
          <input style={S.input} value={draft.timeOfDay||""} onChange={e=>setDraft(p=>({...p,timeOfDay:e.target.value}))} placeholder="06:30"/>
        </div>
        <div>
          <label style={S.label}>{t.duration}</label>
          <input style={S.input} type="number" value={draft.duration||""} onChange={e=>setDraft(p=>({...p,duration:e.target.value}))}/>
        </div>
        <div>
          <label style={S.label}>{t.owner}</label>
          <input style={S.input} value={draft.owner||""} onChange={e=>setDraft(p=>({...p,owner:e.target.value}))}/>
        </div>
        <div style={{gridColumn:"1/-1"}}>
          <label style={S.label}>{t.standard}</label>
          <textarea style={{...S.input,height:54,resize:"vertical"}} value={draft.standard||""} onChange={e=>setDraft(p=>({...p,standard:e.target.value}))} placeholder={lang==="es"?"¬øC√≥mo se ve bien hecho?":"What does good look like?"}/>
        </div>
        <div style={{gridColumn:"1/-1"}}>
          <label style={S.label}>{t.auditTier} <span style={{color:"#4b5563",fontWeight:400,letterSpacing:0}}>‚Äî {t.auditTierHint}</span></label>
          <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:4}}>
            {LEVELS.map(l=>(
              <button key={l} onClick={()=>toggleAudit(l)}
                style={{...S.pill,fontSize:10,...(draft.auditTier.includes(l)?{background:LC[l]+"33",color:LC[l],borderColor:LC[l]}:{})}}>{LL[l][lang]}</button>
            ))}
          </div>
        </div>
      </div>
      <div style={{display:"flex",gap:8,marginTop:12}}>
        <button onClick={save} style={{background:accent,border:"none",color:"#000",borderRadius:6,padding:"7px 16px",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit"}}>{t.saveActivity}</button>
        <button onClick={()=>setEditing(false)} style={{...S.pill}}>{lang==="es"?"Cancelar":"Cancel"}</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App(){
  const [lang,setLang]=useState("en");
  const t=T[lang];
  const [activeLevel,setActiveLevel]=useState("Supervisor");
  const [activeTab,setActiveTab]=useState("log");
  const [tasksByLevel,setTasksByLevel]=useState({"Team Member":[],"Team Leader":[],"Supervisor":[],"Manager":[]});
  const [requiredByLevel,setRequiredByLevel]=useState({"Team Member":[],"Team Leader":[],"Supervisor":[],"Manager":[]});
  const [watchByLevel,setWatchByLevel]=useState({"Team Member":[],"Team Leader":[],"Supervisor":[],"Manager":[]});
  const [reflections,setReflections]=useState({});
  const [newDesc,setNewDesc]=useState("");
  const [newTaskId,setNewTaskId]=useState(null);
  const [newReq,setNewReq]=useState({text:"",freq:"",timeOfDay:"",duration:"",owner:"",standard:"",dayOfWeek:"",dayOfMonth:"",auditTier:[]});
  const [newWatch,setNewWatch]=useState({text:"",cat:"",threshold:"",checkBy:[],timesPerDay:1,auditNote:""});
  const [expandedWatch,setExpandedWatch]=useState(null);
  const [notification,setNotification]=useState(null);
  const [guideAI,setGuideAI]=useState({});
  const [guideAILoad,setGuideAILoad]=useState({});
  const [showLogHints,setShowLogHints]=useState(false);
  const [newReqFreq,setNewReqFreq]=useState("");

  const notify=msg=>{setNotification(msg);setTimeout(()=>setNotification(null),2500);};
  const accent=LC[activeLevel];

  // Auto-load level templates when switching levels with no existing required items
  useEffect(()=>{
    setRequiredByLevel(p=>{
      const current = p[activeLevel]||[];
      if(current.length>0) return p; // don't overwrite existing data
      if(activeLevel==="Supervisor"){
        const tpl=(lang==="es"?SUPERVISOR_TEMPLATE_ES:SUPERVISOR_TEMPLATE_EN).map(x=>({...x,id:uid()}));
        return {...p,"Supervisor":tpl};
      }
      if(activeLevel==="Manager"){
        return {...p,"Manager":MANAGER_TEMPLATE.map(x=>({...x,id:uid()}))};
      }
      if(activeLevel==="Team Leader"){
        return {...p,"Team Leader":TL_TEMPLATE.map(x=>({...x,id:uid()}))};
      }
      return p;
    });
  },[activeLevel]);
  const tasks=tasksByLevel[activeLevel]||[];
  const setTasks=fn=>setTasksByLevel(p=>({...p,[activeLevel]:typeof fn==="function"?fn(p[activeLevel]):fn}));
  const required=requiredByLevel[activeLevel]||[];
  const setRequired=fn=>setRequiredByLevel(p=>({...p,[activeLevel]:typeof fn==="function"?fn(p[activeLevel]):fn}));
  const watchItems=watchByLevel[activeLevel]||[];
  const setWatch=fn=>setWatchByLevel(p=>({...p,[activeLevel]:typeof fn==="function"?fn(p[activeLevel]):fn}));

  const addTask=()=>{
    if(!newDesc.trim())return;
    const id=uid();
    setTasks(p=>[...p,{id,description:newDesc,category:"",minutes:0,isFirefighting:false,disposition:null,notes:"",owner:"",timeBin:""}]);
    setNewTaskId(id);setNewDesc("");
    setTimeout(()=>setNewTaskId(null),300); // clear after render so only new card opens
  };

  const addRequired=()=>{
    if(!newReq.text.trim())return;
    setRequired(p=>[...p,{id:uid(),...newReq,auditTier:newReq.auditTier||[]}]);
    setNewReq({text:"",freq:"",timeOfDay:"",duration:"",owner:"",standard:"",dayOfWeek:"",dayOfMonth:"",auditTier:[]});
    setNewReqFreq("");notify(t.saving);
  };

  const loadTemplate=()=>{
    const tpl=(lang==="es"?SUPERVISOR_TEMPLATE_ES:SUPERVISOR_TEMPLATE_EN).map(x=>({...x,id:uid()}));
    setRequired(tpl);notify(t.templateLoaded);
  };

  const addWatch=()=>{
    if(!newWatch.text.trim())return;
    setWatch(p=>[...p,{id:uid(),...newWatch}]);
    setNewWatch({text:"",cat:"",threshold:"",checkBy:[],timesPerDay:1,auditNote:""});
    notify(t.saving);
  };

  const toggleCheckBy=l=>setNewWatch(p=>({...p,checkBy:p.checkBy.includes(l)?p.checkBy.filter(x=>x!==l):[...p.checkBy,l]}));
  const toggleWatchCheckBy=(id,l)=>setWatch(p=>p.map(w=>w.id===id?{...w,checkBy:w.checkBy?.includes(l)?w.checkBy.filter(x=>x!==l):[...(w.checkBy||[]),l]}:w));
  const toggleAuditNew=l=>setNewReq(p=>({...p,auditTier:p.auditTier?.includes(l)?p.auditTier.filter(x=>x!==l):[...(p.auditTier||[]),l]}));

  const totalMins=tasks.reduce((s,x)=>s+(x.minutes||0),0);
  const ffMins=tasks.filter(x=>x.isFirefighting).reduce((s,x)=>s+(x.minutes||0),0);
  const wrongMins=tasks.filter(x=>x.disposition==="PUSH_DOWN").reduce((s,x)=>s+(x.minutes||0),0);

  const [showExportModal,setShowExportModal]=useState(false);
  const handleExport=()=>setShowExportModal(true);
  const doExportPDF=()=>{
    exportPDFTrifold(tasks,required,watchItems,activeLevel,lang,t,accent);
    setShowExportModal(false);notify(t.saving);
  };
  const doExportXL=()=>{
    exportExcelTrifold(tasks,required,watchItems,activeLevel,lang,t);
    setShowExportModal(false);notify(t.saving);
  };

  const runGuideAI=async(level,qIdx,question,reflection)=>{
    const key=`${level}_${qIdx}`;
    setGuideAILoad(p=>({...p,[key]:true}));setGuideAI(p=>({...p,[key]:""}));
    const ctx=`Leader level: ${LL[level]?.en}. Coach question: "${question}". Leader's reflection: "${reflection||"(no response)"}". Analyze ‚Äî wrong-level work? Unsystematic firefighting? Good practice? One probing follow-up.`;
    const r=await getAICoaching(ctx,lang);
    setGuideAI(p=>({...p,[key]:r||t.aiError}));setGuideAILoad(p=>({...p,[key]:false}));
  };

  const tabBtn=id=>({padding:"8px 12px",borderRadius:"6px 6px 0 0",cursor:"pointer",fontSize:10,fontWeight:700,letterSpacing:1,border:"none",fontFamily:"inherit",background:activeTab===id?"#0f172a":"transparent",color:activeTab===id?accent:"#4b5563",borderBottom:activeTab===id?`2px solid ${accent}`:"2px solid transparent"});

  // ‚îÄ‚îÄ LSW Schedule builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const buildLSW=()=>{
    const bins=t.timeBins;
    return bins.map(bin=>{
      const reqItems=required.filter(r=>{
        const f=r.freq||"";
        if(bin===bins[5]) return f==="Monthly"||f==="Mensual";
        if(bin===bins[4]) return f==="Weekly"||f==="Semanal";
        if(bin===bins[0]) return r.timeBin===bins[0]||(f.includes("Shift")||f.includes("Turno"))&&r.timeBin!==bins[3];
        return r.timeBin===bin;
      });
      const taskItems=tasks.filter(x=>x.disposition==="MAINTAIN"&&x.timeBin===bin);
      const auditItems=required.filter(r=>r.auditTier?.length>0&&(r.timeBin===bin||(bin===bins[4]&&(r.freq==="Weekly"||r.freq==="Semanal"))));
      return{bin,reqItems,taskItems,auditItems};
    });
  };

  const isWeeklyNew=(newReqFreq==="Weekly"||newReqFreq==="Semanal");
  const isMonthlyNew=(newReqFreq==="Monthly"||newReqFreq==="Mensual");

  return(
    <div style={{minHeight:"100vh",background:"#060b12",fontFamily:"'DM Mono','Courier New',monospace",color:"#e2e8f0"}}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Barlow+Condensed:wght@700;800&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#3b82f6!important}
        ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:#1f2937}
        @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
        .fade{animation:fadeUp 0.25s ease}
        @keyframes sIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
        .notif{animation:sIn 0.3s ease}
      `}</style>

      {notification&&<div className="notif" style={{position:"fixed",top:14,right:14,background:"#16a34a",color:"#fff",padding:"9px 16px",borderRadius:8,fontSize:12,fontWeight:700,zIndex:999,letterSpacing:1}}>‚úì {notification}</div>}

      {/* HEADER */}
      <div style={{background:"#080e18",borderBottom:"1px solid #0f1925",padding:"12px 16px"}}>
        <div style={{maxWidth:880,margin:"0 auto",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:10}}>
          <div>
            <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:20,fontWeight:800,letterSpacing:2,color:"#f9fafb"}}>{t.appTitle}</div>
            <div style={{fontSize:9,letterSpacing:3,color:"#374151",marginTop:1}}>{t.appSub}</div>
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}>
            <div style={{display:"flex",background:"#111827",border:"1px solid #1f2937",borderRadius:20,overflow:"hidden"}}>
              {["en","es"].map(l=>(
                <button key={l} onClick={()=>setLang(l)} style={{padding:"6px 14px",border:"none",cursor:"pointer",fontFamily:"inherit",fontSize:11,fontWeight:700,background:lang===l?accent:"transparent",color:lang===l?"#000":"#6b7280",transition:"all 0.2s"}}>{l.toUpperCase()}</button>
              ))}
            </div>
            {totalMins>0&&(
              <div style={{display:"flex",gap:6}}>
                <StatBadge val={`${totalMins}m`} label={t.logged} color="#6b7280"/>
                {ffMins>0&&<StatBadge val={`${Math.round((ffMins/totalMins)*100)}%`} label={t.firefighting} color="#f97316"/>}
                {wrongMins>0&&<StatBadge val={`${Math.round((wrongMins/totalMins)*100)}%`} label={t.wrongLevel} color="#d97706"/>}
              </div>
            )}
            <button onClick={handleExport} style={{background:accent+"22",border:`1px solid ${accent}66`,color:accent,borderRadius:6,padding:"7px 14px",cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:"inherit",letterSpacing:1}}>‚Üì {t.exportLSW} ({LL[activeLevel][lang]})</button>
          </div>
        </div>
      </div>

      {/* LEVEL */}
      <div style={{background:"#080e18",borderBottom:"1px solid #0f1925",padding:"10px 16px"}}>
        <div style={{maxWidth:880,margin:"0 auto",display:"flex",gap:6,alignItems:"center",overflowX:"auto",paddingBottom:2}}>
          <span style={{fontSize:9,color:"#374151",letterSpacing:2,marginRight:4}}>{t.loggingFor}</span>
          {LEVELS.map(l=>(
            <button key={l} onClick={()=>setActiveLevel(l)} style={{padding:"6px 12px",borderRadius:6,cursor:"pointer",fontSize:10,fontWeight:700,letterSpacing:1,border:`1px solid ${activeLevel===l?LC[l]:"#1f2937"}`,background:activeLevel===l?LC[l]+"22":"transparent",color:activeLevel===l?LC[l]:"#4b5563",fontFamily:"inherit",transition:"all 0.2s"}}>
              {LL[l][lang].toUpperCase()}
              {tasksByLevel[l].length>0&&<span style={{marginLeft:5,background:LC[l]+"33",color:LC[l],borderRadius:10,padding:"1px 5px",fontSize:9}}>{tasksByLevel[l].length}</span>}
            </button>
          ))}
        </div>
      </div>

      {/* TABS */}
      <div style={{background:"#060b12",borderBottom:"1px solid #0f1925",padding:"0 16px",overflowX:"auto"}}>
        <div style={{maxWidth:880,margin:"0 auto",display:"flex",gap:2,minWidth:"max-content"}}>
          {Object.entries(t.tabs).map(([id,label])=>(
            <button key={id} style={tabBtn(id)} onClick={()=>setActiveTab(id)}>{label}</button>
          ))}
        </div>
      </div>

      <div style={{padding:"18px 16px",maxWidth:880,margin:"0 auto"}}>

        {/* ‚îÄ‚îÄ LOG TASKS ‚îÄ‚îÄ */}
        {activeTab==="log"&&(
          <div className="fade">
            {/* Instructions */}
            <div style={{background:"#0a0f1a",border:`1px solid ${accent}44`,borderRadius:10,marginBottom:16,overflow:"hidden"}}>
              <button onClick={()=>setShowLogHints(!showLogHints)} style={{width:"100%",display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",background:"transparent",border:"none",cursor:"pointer",color:accent,fontFamily:"inherit"}}>
                <span style={{fontSize:10,letterSpacing:2,fontWeight:700}}>? {t.logInstructions} ‚Äî {LL[activeLevel][lang].toUpperCase()}</span>
                <span style={{fontSize:11}}>{showLogHints?"‚ñ≤":"‚ñº"}</span>
              </button>
              {showLogHints&&(
                <div style={{padding:"0 16px 16px",borderTop:`1px solid ${accent}22`}}>
                  {(t.logHints[activeLevel]||[]).map((h,i)=>(
                    <div key={i} style={{display:"flex",gap:8,marginTop:8}}>
                      <span style={{color:accent,flexShrink:0,marginTop:1}}>¬∑</span>
                      <span style={{fontSize:12,color:"#94a3b8",lineHeight:1.6}}>{h}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div style={{display:"flex",gap:10,marginBottom:20}}>
              <input style={{...S.input,flex:1,fontSize:13}} value={newDesc}
                onChange={e=>setNewDesc(e.target.value)}
                onKeyDown={e=>e.key==="Enter"&&addTask()}
                placeholder={`${t.addTask} ${LL[activeLevel][lang]}? ${t.addTaskHint}`}/>
              <button onClick={addTask} style={{background:newDesc.trim()?accent:"#1f2937",border:"none",color:newDesc.trim()?"#000":"#374151",borderRadius:6,padding:"0 18px",cursor:"pointer",fontSize:20,fontWeight:900,fontFamily:"inherit",minWidth:48}}>‚úì</button>
            </div>

            {tasks.length===0?(
              <div style={{textAlign:"center",padding:"50px 0",color:"#1f2937"}}>
                <div style={{fontSize:36,marginBottom:10}}>üìã</div>
                <div style={{fontFamily:"'Barlow Condensed'",fontSize:20,letterSpacing:2,color:"#374151"}}>{t.noTasks}</div>
                <div style={{fontSize:11,marginTop:6,color:"#1f2937"}}>{t.noTasksSub}</div>
              </div>
            ):(
              <>
                <div style={{fontSize:10,color:"#4b5563",letterSpacing:1,marginBottom:10}}>{tasks.length} {t.taskCount}</div>
                {tasks.map(task=>(
                  <div key={task.id} className="fade">
                    <TaskCard task={task} onUpdate={u=>setTasks(p=>p.map(x=>x.id===u.id?u:x))} onDelete={()=>setTasks(p=>p.filter(x=>x.id!==task.id))} level={activeLevel} lang={lang} t={t} autoOpen={task.id===newTaskId}/>
                  </div>
                ))}
              </>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ MY LSW ‚îÄ‚îÄ */}
        {activeTab==="lsw"&&(
          <div className="fade">
            <div style={{marginBottom:16}}>
              <div style={{fontFamily:"'Barlow Condensed'",fontSize:18,fontWeight:800,letterSpacing:2,color:accent,marginBottom:4}}>{t.lswTitle}</div>
              <div style={{fontSize:11,color:"#6b7280"}}>{t.lswSub}</div>
            </div>
            {(required.length===0&&tasks.filter(x=>x.disposition==="MAINTAIN").length===0)?(
              <div style={{textAlign:"center",color:"#374151",padding:40,fontSize:12}}>{t.noLSW}</div>
            ):(
              <>
                {buildLSW().map(({bin,reqItems,taskItems,auditItems})=>{
                  if(!reqItems.length&&!taskItems.length) return null;
                  return(
                    <div key={bin} style={{marginBottom:20}}>
                      <div style={{fontSize:10,letterSpacing:2,color:accent,fontWeight:700,marginBottom:8,paddingBottom:6,borderBottom:`1px solid ${accent}33`}}>{bin.toUpperCase()}</div>
                      {reqItems.map(r=>{
                        let freqBadge=r.freq||"";
                        if((r.freq==="Weekly"||r.freq==="Semanal")&&r.dayOfWeek) freqBadge+=` ¬∑ ${r.dayOfWeek}`;
                        if((r.freq==="Monthly"||r.freq==="Mensual")&&r.dayOfMonth) freqBadge+=` ¬∑ Day ${r.dayOfMonth}`;
                        return(
                          <div key={r.id} style={{display:"flex",gap:10,padding:"11px 14px",background:"#0f172a",border:`1px solid ${accent}33`,borderRadius:8,marginBottom:6,alignItems:"flex-start"}}>
                            <div style={{minWidth:48,textAlign:"center",background:accent+"22",borderRadius:6,padding:"4px 6px",flexShrink:0}}>
                              <div style={{fontSize:10,color:accent,fontWeight:700}}>{r.timeOfDay||"‚Äî"}</div>
                              {r.duration&&<div style={{fontSize:9,color:"#6b7280"}}>{r.duration}m</div>}
                            </div>
                            <div style={{flex:1,minWidth:0}}>
                              <div style={{fontSize:13,color:"#f9fafb",fontWeight:500,marginBottom:3}}>{r.text}</div>
                              {r.standard&&<div style={{fontSize:11,color:"#6b7280",fontStyle:"italic",marginBottom:3}}>‚Üí {r.standard}</div>}
                              {r.auditTier?.length>0&&(
                                <div style={{display:"flex",gap:4,flexWrap:"wrap",marginTop:3}}>
                                  <span style={{fontSize:9,color:"#a855f7",letterSpacing:1,marginRight:2}}>üèó VERIFY:</span>
                                  {r.auditTier.map(l=>(
                                    <span key={l} style={{fontSize:9,background:LC[l]+"33",color:LC[l],border:`1px solid ${LC[l]}44`,padding:"1px 6px",borderRadius:3}}>{LL[l][lang]}</span>
                                  ))}
                                </div>
                              )}
                            </div>
                            <div style={{display:"flex",flexDirection:"column",gap:4,alignItems:"flex-end",flexShrink:0}}>
                              <span style={{fontSize:9,background:r.freq==="Each Shift"||r.freq==="Cada Turno"?accent+"44":accent+"22",color:accent,border:`1px solid ${accent}44`,padding:"2px 7px",borderRadius:3,whiteSpace:"nowrap"}}>{freqBadge}{(r.freq==="Each Shift"||r.freq==="Cada Turno")?" ‚Üª":""}</span>
                              <div style={{width:22,height:22,border:"2px solid #374151",borderRadius:4,background:"#0a0f1a"}}/>
                            </div>
                          </div>
                        );
                      })}
                      {taskItems.map(x=>(
                        <div key={x.id} style={{display:"flex",gap:10,padding:"10px 14px",background:"#052e1622",border:"1px solid #16a34a33",borderRadius:8,marginBottom:6,alignItems:"center"}}>
                          <span style={{color:"#16a34a",fontSize:14,flexShrink:0}}>‚úì</span>
                          <div style={{flex:1}}>
                            <div style={{fontSize:13,color:"#f9fafb"}}>{x.description}</div>
                            {x.category&&<div style={{fontSize:11,color:"#6b7280",marginTop:1}}>{x.category}{x.minutes?` ¬∑ ${x.minutes}min`:""}</div>}
                          </div>
                          <div style={{width:22,height:22,border:"2px solid #374151",borderRadius:4,background:"#0a0f1a",flexShrink:0}}/>
                        </div>
                      ))}
                    </div>
                  );
                })}

                {/* Layered Audit Summary in LSW */}
                {required.some(r=>r.auditTier?.length>0)&&(
                  <div style={{marginTop:8,background:"#0a0f1a",border:"1px solid #a855f744",borderRadius:12,padding:18}}>
                    <div style={{fontSize:10,letterSpacing:2,color:"#a855f7",fontWeight:700,marginBottom:4}}>üèó {t.lswLayeredAudit}</div>
                    <div style={{fontSize:11,color:"#6b7280",marginBottom:14}}>{t.layeredAuditDesc}</div>
                    {LEVELS.slice().reverse().map(level=>{
                      const assigned=required.filter(r=>r.auditTier?.includes(level));
                      if(!assigned.length) return null;
                      return(
                        <div key={level} style={{display:"flex",gap:10,marginBottom:10,alignItems:"flex-start"}}>
                          <div style={{minWidth:80,fontSize:9,color:LC[level],fontWeight:700,letterSpacing:1,background:LC[level]+"22",border:`1px solid ${LC[level]}44`,borderRadius:4,padding:"3px 8px",textAlign:"center",flexShrink:0}}>{LL[level][lang].toUpperCase()}</div>
                          <div style={{flex:1}}>
                            {assigned.map(r=>{
                              let fb=r.freq||"";
                              if((r.freq==="Weekly"||r.freq==="Semanal")&&r.dayOfWeek) fb+=` ¬∑ ${r.dayOfWeek}`;
                              if((r.freq==="Monthly"||r.freq==="Mensual")&&r.dayOfMonth) fb+=` ¬∑ Day ${r.dayOfMonth}`;
                              return(
                                <div key={r.id} style={{display:"flex",gap:6,alignItems:"center",marginBottom:4}}>
                                  <div style={{width:5,height:5,borderRadius:"50%",background:LC[level],flexShrink:0}}/>
                                  <span style={{fontSize:12,color:"#94a3b8"}}>{r.text}</span>
                                  {fb&&<span style={{fontSize:9,color:"#4b5563"}}>¬∑ {fb}</span>}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ REQUIRED ACTIVITIES ‚îÄ‚îÄ */}
        {activeTab==="required"&&(
          <div className="fade">
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:16,flexWrap:"wrap",gap:8}}>
              <p style={{fontSize:12,color:"#6b7280",lineHeight:1.7,flex:1}}>{t.requiredSub}</p>
              {activeLevel==="Supervisor"&&(
                <button onClick={loadTemplate} style={{background:"#a855f722",border:"1px solid #a855f744",color:"#a855f7",borderRadius:6,padding:"8px 14px",cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:"inherit",whiteSpace:"nowrap"}}>
                  ‚ö° {t.loadTemplate}
                </button>
              )}
            </div>

            {/* Add Form */}
            <div style={{background:"#0f172a",border:`1px solid ${accent}44`,borderRadius:10,padding:16,marginBottom:20}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr auto",gap:10,marginBottom:12}}>
                <input style={S.input} value={newReq.text} onChange={e=>setNewReq(p=>({...p,text:e.target.value}))}
                  onKeyDown={e=>e.key==="Enter"&&addRequired()} placeholder={t.addRequired}/>
                <button onClick={addRequired} style={{background:accent,border:"none",color:"#000",borderRadius:6,padding:"0 16px",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",whiteSpace:"nowrap"}}>{t.addActivity}</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10}}>
                <div>
                  <label style={S.label}>{t.freq}</label>
                  <select style={S.input} value={newReqFreq}
                    onChange={e=>{setNewReqFreq(e.target.value);setNewReq(p=>({...p,freq:e.target.value}))}}>
                    <option value="">{t.selectCat}</option>
                    {t.freqOpts.map(f=><option key={f}>{f}</option>)}
                  </select>
                </div>
                {isWeeklyNew&&(
                  <div>
                    <label style={S.label}>{t.dayOfWeek}</label>
                    <select style={S.input} value={newReq.dayOfWeek} onChange={e=>setNewReq(p=>({...p,dayOfWeek:e.target.value}))}>
                      <option value="">{t.selectCat}</option>
                      {t.weekdays.map(d=><option key={d}>{d}</option>)}
                    </select>
                  </div>
                )}
                {isMonthlyNew&&(
                  <div>
                    <label style={S.label}>{t.dayOfMonth}</label>
                    <input style={S.input} type="number" min={1} max={31} value={newReq.dayOfMonth} onChange={e=>setNewReq(p=>({...p,dayOfMonth:e.target.value}))} placeholder="1‚Äì31"/>
                  </div>
                )}
                <div>
                  <label style={S.label}>{t.timeOfDay}</label>
                  <input style={S.input} value={newReq.timeOfDay} onChange={e=>setNewReq(p=>({...p,timeOfDay:e.target.value}))} placeholder="06:30"/>
                </div>
                <div>
                  <label style={S.label}>{t.duration}</label>
                  <input style={S.input} type="number" value={newReq.duration} onChange={e=>setNewReq(p=>({...p,duration:e.target.value}))}/>
                </div>
                <div>
                  <label style={S.label}>{t.owner}</label>
                  <input style={S.input} value={newReq.owner} onChange={e=>setNewReq(p=>({...p,owner:e.target.value}))} placeholder={LL[activeLevel][lang]}/>
                </div>
                <div style={{gridColumn:"1/-1"}}>
                  <label style={S.label}>{t.standard}</label>
                  <input style={S.input} value={newReq.standard} onChange={e=>setNewReq(p=>({...p,standard:e.target.value}))} placeholder={lang==="es"?"¬øC√≥mo se ve bien hecho?":"What does good look like?"}/>
                </div>
                <div style={{gridColumn:"1/-1"}}>
                  <label style={S.label}>{t.auditTier} <span style={{color:"#4b5563",fontWeight:400,letterSpacing:0}}>‚Äî {t.auditTierHint}</span></label>
                  <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:4}}>
                    {LEVELS.map(l=>(
                      <button key={l} onClick={()=>toggleAuditNew(l)}
                        style={{...S.pill,fontSize:10,...(newReq.auditTier?.includes(l)?{background:LC[l]+"33",color:LC[l],borderColor:LC[l]}:{})}}>{LL[l][lang]}</button>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {required.length===0?(
              <div style={{textAlign:"center",color:"#374151",padding:30,fontSize:12}}>
                {lang==="es"?"Agrega tu primera actividad o carga la plantilla.":"Add your first activity or load the template."}
                {activeLevel==="Supervisor"&&<div style={{marginTop:10}}><button onClick={loadTemplate} style={{background:accent+"22",border:`1px solid ${accent}66`,color:accent,borderRadius:6,padding:"8px 16px",cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:"inherit"}}>‚ö° {t.loadTemplate}</button></div>}
              </div>
            ):(
              required.map(r=>(
                <RequiredCard key={r.id} item={r} lang={lang} t={t} accent={accent}
                  onUpdate={u=>setRequired(p=>p.map(x=>x.id===u.id?u:x))}
                  onDelete={()=>setRequired(p=>p.filter(x=>x.id!==r.id))}/>
              ))
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ CRITICAL WATCH ‚îÄ‚îÄ */}
        {activeTab==="watch"&&(
          <div className="fade">
            <p style={{fontSize:12,color:"#6b7280",marginBottom:16,lineHeight:1.7}}>{t.watchSub}</p>
            <div style={{background:"#0f172a",border:"1px solid #1f2937",borderRadius:10,padding:16,marginBottom:20}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr auto",gap:10,marginBottom:12}}>
                <input style={S.input} value={newWatch.text} onChange={e=>setNewWatch(p=>({...p,text:e.target.value}))} onKeyDown={e=>e.key==="Enter"&&addWatch()} placeholder={t.addWatch}/>
                <button onClick={addWatch} style={{background:accent,border:"none",color:"#000",borderRadius:6,padding:"0 14px",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",whiteSpace:"nowrap"}}>{t.addWatchItem}</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10}}>
                <div>
                  <label style={S.label}>{t.watchCat}</label>
                  <select style={S.input} value={newWatch.cat} onChange={e=>setNewWatch(p=>({...p,cat:e.target.value}))}>
                    <option value="">{t.selectCat}</option>
                    {t.watchCats.map(c=><option key={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label style={S.label}>{t.timesPerDay}</label>
                  <input style={S.input} type="number" min={1} value={newWatch.timesPerDay} onChange={e=>setNewWatch(p=>({...p,timesPerDay:parseInt(e.target.value)||1}))}/>
                </div>
                <div>
                  <label style={S.label}>{t.threshold}</label>
                  <input style={S.input} value={newWatch.threshold} onChange={e=>setNewWatch(p=>({...p,threshold:e.target.value}))} placeholder={t.thresholdPH}/>
                </div>
                <div style={{gridColumn:"1/-1"}}>
                  <label style={S.label}>{t.checkBy}</label>
                  <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:4}}>
                    {LEVELS.map(l=>(
                      <button key={l} onClick={()=>toggleCheckBy(l)}
                        style={{...S.pill,fontSize:10,...(newWatch.checkBy.includes(l)?{background:LC[l]+"33",color:LC[l],borderColor:LC[l]}:{})}}>{LL[l][lang]}</button>
                    ))}
                  </div>
                </div>
                <div style={{gridColumn:"1/-1"}}>
                  <label style={S.label}>{t.auditNote}</label>
                  <input style={S.input} value={newWatch.auditNote} onChange={e=>setNewWatch(p=>({...p,auditNote:e.target.value}))} placeholder={t.auditNotePH}/>
                </div>
              </div>
            </div>

            {watchItems.length===0?(
              <div style={{textAlign:"center",color:"#374151",padding:30,fontSize:12}}>{t.noWatchYet}</div>
            ):(
              <>
                {t.watchCats.map(cat=>{
                  const items=watchItems.filter(w=>w.cat===cat);
                  if(!items.length) return null;
                  const wc=WATCH_COLORS[cat]||"#6b7280";
                  return(
                    <div key={cat} style={{marginBottom:18}}>
                      <div style={{fontSize:10,letterSpacing:2,color:wc,fontWeight:700,marginBottom:8,display:"flex",alignItems:"center",gap:8}}>
                        <div style={{width:8,height:8,borderRadius:"50%",background:wc}}/>{cat.toUpperCase()} ({items.length})
                      </div>
                      {items.map(w=>(
                        <div key={w.id} style={{...S.card,border:`1px solid ${wc}44`,marginBottom:8}}>
                          <div style={{padding:"12px 16px",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}} onClick={()=>setExpandedWatch(expandedWatch===w.id?null:w.id)}>
                            <div>
                              <div style={{fontSize:13,color:"#f9fafb"}}>{w.text}</div>
                              <div style={{display:"flex",gap:8,marginTop:4,flexWrap:"wrap"}}>
                                {w.threshold&&<span style={{fontSize:11,color:wc}}>‚ö° {w.threshold}</span>}
                                {w.timesPerDay>0&&<span style={{fontSize:10,color:"#6b7280"}}>¬∑ {w.timesPerDay}x/day</span>}
                                {w.checkBy?.length>0&&<span style={{fontSize:10,color:"#a855f7"}}>¬∑ {w.checkBy.map(l=>LL[l][lang]).join(", ")}</span>}
                              </div>
                            </div>
                            <span style={{color:"#4b5563",fontSize:11}}>{expandedWatch===w.id?"‚ñ≤":"‚ñº"}</span>
                          </div>
                          {expandedWatch===w.id&&(
                            <div style={{padding:"0 16px 14px",borderTop:"1px solid #1f2937"}}>
                              <div style={{marginTop:10}}>
                                <label style={S.label}>{t.checkBy}</label>
                                <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:4}}>
                                  {LEVELS.map(l=>(
                                    <button key={l} onClick={()=>toggleWatchCheckBy(w.id,l)}
                                      style={{...S.pill,fontSize:10,...(w.checkBy?.includes(l)?{background:LC[l]+"33",color:LC[l],borderColor:LC[l]}:{})}}>{LL[l][lang]}</button>
                                  ))}
                                </div>
                              </div>
                              <div style={{marginTop:10}}>
                                <label style={S.label}>{t.timesPerDay}</label>
                                <input style={{...S.input,width:80}} type="number" min={1} value={w.timesPerDay||1}
                                  onChange={e=>setWatch(p=>p.map(x=>x.id===w.id?{...x,timesPerDay:parseInt(e.target.value)||1}:x))}/>
                              </div>
                              {w.auditNote&&<div style={{fontSize:12,color:"#94a3b8",marginTop:8}}><span style={{color:"#6b7280"}}>{t.auditNote}:</span> {w.auditNote}</div>}
                              <button onClick={()=>setWatch(p=>p.filter(x=>x.id!==w.id))} style={{marginTop:10,background:"transparent",border:"1px solid #dc262644",color:"#dc2626",borderRadius:6,padding:"5px 12px",cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>{t.remove}</button>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  );
                })}
                {watchItems.some(w=>w.checkBy?.length>0)&&(
                  <div style={{marginTop:20,background:"#0a0f1a",border:`1px solid ${accent}44`,borderRadius:12,padding:18}}>
                    <div style={{fontSize:10,letterSpacing:2,color:accent,fontWeight:700,marginBottom:4}}>üèó {t.layeredAuditSeed}</div>
                    <div style={{fontSize:11,color:"#6b7280",marginBottom:14}}>{t.layeredAuditDesc}</div>
                    {LEVELS.slice().reverse().map(level=>{
                      const assigned=watchItems.filter(w=>w.checkBy?.includes(level));
                      if(!assigned.length) return null;
                      return(
                        <div key={level} style={{display:"flex",gap:10,marginBottom:10,alignItems:"flex-start"}}>
                          <div style={{minWidth:80,fontSize:9,color:LC[level],fontWeight:700,letterSpacing:1,background:LC[level]+"22",border:`1px solid ${LC[level]}44`,borderRadius:4,padding:"3px 8px",textAlign:"center",flexShrink:0}}>{LL[level][lang].toUpperCase()}</div>
                          <div style={{flex:1}}>
                            {assigned.map(w=>(
                              <div key={w.id} style={{display:"flex",gap:8,alignItems:"center",marginBottom:4}}>
                                <div style={{width:5,height:5,borderRadius:"50%",background:WATCH_COLORS[w.cat]||"#6b7280",flexShrink:0}}/>
                                <span style={{fontSize:12,color:"#94a3b8"}}>{w.text}</span>
                                {w.timesPerDay>0&&<span style={{fontSize:10,color:"#4b5563"}}>¬∑ {w.timesPerDay}x/day</span>}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ GUIDE ‚îÄ‚îÄ */}
        {activeTab==="guide"&&(
          <div className="fade">
            <div style={{background:"#0a1020",border:"1px solid #1f2937",borderRadius:10,padding:14,marginBottom:20}}>
              <p style={{fontSize:12,color:"#6b7280",lineHeight:1.7}}>{lang==="en"?"Gemba questions. Answer as how you actually spent your last 5 days ‚Äî not your job description. The gap between those two things is the work.":"Preguntas de gemba. Responde como realmente pasaste tus √∫ltimos 5 d√≠as ‚Äî no tu descripci√≥n del puesto. La brecha entre ambos es el trabajo."}</p>
            </div>
            {(GUIDE_QS[activeLevel]?.[lang]||[]).map((q,i)=>{
              const key=`${activeLevel}_${i}`;
              return(
                <div key={i} style={{background:"#0f172a",border:"1px solid #1f2937",borderRadius:10,padding:16,marginBottom:10}}>
                  <div style={{display:"flex",gap:10,marginBottom:12}}>
                    <span style={{color:accent,fontSize:16,marginTop:1,flexShrink:0}}>‚Üí</span>
                    <p style={{fontSize:13,color:"#e2e8f0",lineHeight:1.6}}>{q}</p>
                  </div>
                  <label style={S.label}>{t.reflectionLabel}</label>
                  <textarea style={{...S.input,height:70,resize:"vertical"}} value={reflections[key]||""} onChange={e=>setReflections(p=>({...p,[key]:e.target.value}))} placeholder={t.reflectionPH}/>
                  <div style={{marginTop:10,display:"flex",justifyContent:"flex-end"}}>
                    <button onClick={()=>runGuideAI(activeLevel,i,q,reflections[key])} disabled={guideAILoad[key]}
                      style={{background:accent+"22",border:`1px solid ${accent}66`,color:accent,borderRadius:6,padding:"5px 12px",cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:"inherit",opacity:guideAILoad[key]?0.6:1}}>
                      ‚ú¶ {guideAILoad[key]?t.aiThinking:t.aiCoachBtn}
                    </button>
                  </div>
                  {guideAI[key]&&(
                    <div style={{marginTop:10,background:"#0a0f1a",border:`1px solid ${accent}44`,borderRadius:8,padding:12}}>
                      <div style={{fontSize:9,letterSpacing:2,color:accent,fontWeight:700,marginBottom:6}}>‚ú¶ {t.aiCoach}</div>
                      <p style={{fontSize:12,color:"#cbd5e1",lineHeight:1.7}}>{guideAI[key]}</p>
                    </div>
                  )}
                </div>
              );
            })}
            <div style={{background:"#1c020244",border:"1px solid #dc262633",borderRadius:10,padding:16,marginTop:20}}>
              <h3 style={{fontSize:10,letterSpacing:2,color:"#dc2626",marginBottom:12,fontWeight:700}}>‚ö† {t.wrongWork}</h3>
              {(WRONG_LEVEL[activeLevel]?.[lang]||[]).map((w,i)=>(
                <div key={i} style={{display:"flex",gap:8,marginBottom:7}}><span style={{color:"#dc2626",flexShrink:0}}>‚úï</span><span style={{fontSize:12,color:"#9ca3af"}}>{w}</span></div>
              ))}
            </div>
          </div>
        )}

        {/* ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ */}
        {activeTab==="analyze"&&(
          <div className="fade">
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(90px,1fr))",gap:8,marginBottom:24}}>
              {Object.entries(DISPOSITIONS).map(([k,d])=>{
                const mins=tasks.filter(x=>x.disposition===k).reduce((s,x)=>s+(x.minutes||0),0);
                return(<div key={k} style={{background:d.bg,border:`1px solid ${d.color}55`,borderRadius:8,padding:"12px 8px",textAlign:"center"}}>
                  <div style={{fontSize:16}}>{d.icon}</div>
                  <div style={{fontSize:9,color:d.color,fontWeight:700,letterSpacing:0.5,margin:"4px 0"}}>{d[lang]}</div>
                  <div style={{fontSize:18,fontWeight:700,color:"#f9fafb"}}>{mins}m</div>
                  <div style={{fontSize:10,color:"#6b7280"}}>{totalMins?Math.round((mins/totalMins)*100):0}%</div>
                </div>);
              })}
            </div>
            {totalMins>0&&(
              <>
                <h2 style={{fontSize:10,letterSpacing:2,color:"#6b7280",marginBottom:14,fontWeight:700}}>{t.timeCat}</h2>
                {CATS[lang].map((cat,i)=>{
                  const m=tasks.filter(x=>x.category===CATS.en[i]||x.category===cat).reduce((s,x)=>s+(x.minutes||0),0);
                  if(!m) return null;
                  const pct=Math.round((m/totalMins)*100);
                  return(<div key={cat} style={{marginBottom:8}}>
                    <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#94a3b8",marginBottom:4}}><span>{cat}</span><span style={{color:"#6b7280"}}>{m}m ¬∑ {pct}%</span></div>
                    <div style={{height:5,background:"#1f2937",borderRadius:3}}><div style={{width:`${pct}%`,height:"100%",background:accent,borderRadius:3,transition:"width 0.4s"}}/></div>
                  </div>);
                })}
              </>
            )}
            <h2 style={{fontSize:10,letterSpacing:2,color:"#6b7280",marginBottom:14,fontWeight:700,marginTop:24}}>{t.crossLevel}</h2>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:10}}>
              {LEVELS.map(l=>{
                const lt=tasksByLevel[l]||[]; const lm=lt.reduce((s,x)=>s+(x.minutes||0),0);
                const lff=lt.filter(x=>x.isFirefighting).reduce((s,x)=>s+(x.minutes||0),0);
                return(<div key={l} onClick={()=>{setActiveLevel(l);setActiveTab("log");}} style={{background:"#0f172a",border:`1px solid ${lt.length>0?LC[l]+"55":"#1f2937"}`,borderRadius:10,padding:14,cursor:"pointer"}}>
                  <div style={{fontFamily:"'Barlow Condensed'",fontSize:14,fontWeight:800,letterSpacing:2,color:LC[l],marginBottom:6}}>{LL[l][lang].toUpperCase()}</div>
                  <div style={{fontSize:11,color:"#6b7280"}}>{lt.length} {t.tasks} ¬∑ {lm}m</div>
                  {lff>0&&lm>0&&<div style={{fontSize:11,color:"#f97316",marginTop:4}}>üî• {Math.round((lff/lm)*100)}%</div>}
                  {lt.filter(x=>x.disposition==="PUSH_DOWN").length>0&&<div style={{fontSize:11,color:"#d97706",marginTop:2}}>‚Üì {lt.filter(x=>x.disposition==="PUSH_DOWN").length} {t.toPushDown}</div>}
                  {lt.length===0&&<div style={{fontSize:10,color:"#374151",marginTop:4}}>{t.noTasksLogged}</div>}
                </div>);
              })}
            </div>
          </div>
        )}

        {/* ‚îÄ‚îÄ ACTION PLAN ‚îÄ‚îÄ */}
        {activeTab==="action"&&(
          <div className="fade">
            <div style={{display:"flex",justifyContent:"flex-end",marginBottom:18}}>
              <button onClick={handleExport} style={{background:accent+"22",border:`1px solid ${accent}66`,color:accent,borderRadius:6,padding:"8px 16px",cursor:"pointer",fontSize:11,fontWeight:700,fontFamily:"inherit",letterSpacing:1}}>‚Üì {t.exportLSW} ({LL[activeLevel][lang]})</button>
            </div>
            {tasks.filter(x=>x.disposition).length===0?(
              <p style={{fontSize:13,color:"#4b5563"}}>{t.noActionYet}</p>
            ):(
              ["MAINTAIN","PUSH_DOWN","ELIMINATE","FIREFIGHTING","ESCALATE"].map(key=>{
                const d=DISPOSITIONS[key];
                // Firefighting is a cross-cutting concern ‚Äî show separately, exclude from disposition groups
                const group=key==="FIREFIGHTING"
                  ?tasks.filter(x=>x.isFirefighting)
                  :tasks.filter(x=>x.disposition===key&&!x.isFirefighting);
                if(!group.length) return null;
                return(
                  <div key={key} style={{...S.ab,borderColor:d.color+"55"}}>
                    <h3 style={{fontSize:10,letterSpacing:2,color:d.color,fontWeight:700,marginBottom:12}}>
                      {d.icon} {key==="MAINTAIN"?t.maintain:key==="PUSH_DOWN"?t.pushDown:key==="ELIMINATE"?t.eliminate:key==="FIREFIGHTING"?t.ffAnalysis:"ESCALATE"} ({group.length})
                    </h3>
                    {key==="MAINTAIN"&&<p style={{fontSize:11,color:"#6b7280",marginBottom:10}}>{t.maintainSub}</p>}
                    {key==="FIREFIGHTING"&&(
                      <div style={{background:"#1c0a0244",border:"1px solid #f9731633",borderRadius:8,padding:12,marginBottom:12}}>
                        <div style={{fontSize:10,color:"#f97316",fontWeight:700}}>{t.keyQuestion}</div>
                        <p style={{fontSize:12,color:"#9ca3af",marginTop:4,lineHeight:1.6}}>{t.keyQuestionText}</p>
                        {Object.entries(group.reduce((a,x)=>{const c=x.firefightingCause||"?";(a[c]=a[c]||[]).push(x);return a;},{})).map(([cause,items])=>(
                          <div key={cause} style={{marginTop:10}}>
                            <div style={{fontSize:11,color:"#f97316",fontWeight:700}}>{cause} ({items.length})</div>
                            {items.map(x=><div key={x.id} style={{fontSize:12,color:"#94a3b8",marginLeft:10,marginTop:3}}>¬∑ {x.description}</div>)}
                          </div>
                        ))}
                      </div>
                    )}
                    {group.map(task=>(
                      <div key={task.id} style={{borderBottom:"1px solid #0f1925",paddingBottom:9,marginBottom:9}}>
                        <div style={{fontSize:13,color:"#f9fafb"}}>{task.description}{task.minutes?<span style={{color:"#4b5563",fontSize:11}}> ({task.minutes}m)</span>:""}</div>
                        {task.pushToLevel&&<div style={{fontSize:11,color:"#d97706",marginTop:3}}>{t.delegateTo} {LL[task.pushToLevel]?.[lang]||task.pushToLevel}</div>}
                        {task.pushNote&&<div style={{fontSize:11,color:"#6b7280",marginTop:2}}>{task.pushNote}</div>}
                        {task.eliminateNote&&<div style={{fontSize:11,color:"#6b7280",marginTop:2}}>{task.eliminateNote}</div>}
                        {task.notes&&<div style={{fontSize:11,color:"#6b7280",marginTop:2,fontStyle:"italic"}}>{task.notes}</div>}
                      </div>
                    ))}
                  </div>
                );
              })
            )}
          </div>
        )}
      </div>
      {/* EXPORT PICKER MODAL */}
      {showExportModal&&(
        <div onClick={()=>setShowExportModal(false)} style={{position:"fixed",inset:0,background:"#000a",zIndex:200,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
          <div onClick={e=>e.stopPropagation()} style={{background:"#0f172a",border:`1px solid ${accent}66`,borderRadius:14,padding:24,width:"100%",maxWidth:340}}>
            <div style={{fontFamily:"'Barlow Condensed',sans-serif",fontSize:16,fontWeight:800,letterSpacing:2,color:"#f9fafb",marginBottom:4}}>{t.exportPickTitle||"EXPORT FORMAT"}</div>
            <div style={{fontSize:11,color:"#6b7280",marginBottom:20}}>{t.exportPickSub||"Choose format for"} {LL[activeLevel][lang]}</div>
            <div style={{display:"flex",flexDirection:"column",gap:10}}>
              <button onClick={doExportPDF} style={{background:"#dc262622",border:"1px solid #dc262666",color:"#f87171",borderRadius:8,padding:"14px 16px",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",textAlign:"left",letterSpacing:1}}>
                <div>‚Üì PDF TRIFOLD</div>
                <div style={{fontSize:10,fontWeight:400,color:"#6b7280",marginTop:3}}>Print-ready ¬∑ Landscape ¬∑ Fold in thirds ¬∑ Action items on back</div>
              </button>
              <button onClick={doExportXL} style={{background:"#16a34a22",border:"1px solid #16a34a66",color:"#4ade80",borderRadius:8,padding:"14px 16px",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",textAlign:"left",letterSpacing:1}}>
                <div>‚Üì EXCEL TRIFOLD</div>
                <div style={{fontSize:10,fontWeight:400,color:"#6b7280",marginTop:3}}>3-column layout ¬∑ Panel 1 / 2 / 3 + back panel ¬∑ Opens in Excel</div>
              </button>
              <button onClick={()=>setShowExportModal(false)} style={{background:"transparent",border:"1px solid #374151",color:"#6b7280",borderRadius:8,padding:"10px 16px",cursor:"pointer",fontSize:11,fontFamily:"inherit",marginTop:4}}>Cancel</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function StatBadge({val,label,color}){
  return(
    <div style={{background:color+"15",border:`1px solid ${color}44`,borderRadius:8,padding:"6px 10px",textAlign:"center"}}>
      <div style={{fontSize:14,fontWeight:700,color,lineHeight:1}}>{val}</div>
      <div style={{fontSize:8,color,opacity:0.7,letterSpacing:1,marginTop:2}}>{label}</div>
    </div>
  );
}


ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>